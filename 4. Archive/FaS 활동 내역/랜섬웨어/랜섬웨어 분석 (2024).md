## 2024 랜섬웨어 분석
- 랜섬웨어 특징 분석
    
    **1, 확장자 확인**
    ⇒ 랜섬웨어 파일을 실행했을 때 확장자가 .fas로 변경됨을 알 수 있었음.
	
    **2, 어떤 파일이 암호화되고 안 되어 있는지**
    - 암호화되어 있었던 파일
        - Dooray!.pdf
        - 네이버카페.pdf
        - 협업 툴 TeamUp과 Agit 데이터베이스 복호화 방안 및 아티팩트 분석 연구.pdf
        - 1.txt
        - 2.txt
        - 3.txt
        - 4.txt
        - 5.txt
        - FaS_20240105_20192243_이용진.pptx
        - 감염사진.png
        - 국민대.jpg
        - 힘들 때 보는 동영상.zip
            ⇒ 랜섬웨어 파일이 있던 디렉토와 그 하위 디렉토리만 암호화 대상으로 추측됨
    
    **3, 랜섬노트**
    분석하려는 랜섬웨어의 랜섬노트 이름: Hazard.txt
    ⇒ 암호화된 파일이 있는 디렉토리마다 랜섬노트가 있는 것을 확인할 수 있었음.
    ⇒ Ghidra로 정적분석을 진행한 결과 랜섬노트(Hazard.txt)를 실행하는 코드를 찾을 수 있었음.
    
- 파일 탐색 함수 확인
	
    **어떤 순서로 파일을 탐색하는지**
    Hazard class의 Operate 함수 안의 Files 함수가 FindFirstFileA, FindNextFileA 등을 사용하는 것으로 보아 Files 함수는 파일 탐색 함수로 추정
    
    - **파일을 탐색하는 순서**
        큐를 사용하는 것으로 보아 BFS 알고리즘으로 파일을 탐색하는 것으로 판단함.
        
    - **WIN32_FIND_DATAA 구조체**
        FindFirstFile, FindFirstFileEx 또는 FindNextFile 함수에서 찾은 파일에 대한 정보를 포함하는 구조체 (3번 랜섬웨어에서는 FindFileData라는 이름으로 선언)
        → 탐색한 파일의 정보를 찾은 뒤에 해당하는 파일을 암호화
		
        [WIN32_FIND_DATAA(minwinbase.h) - Win32 apps](https://learn.microsoft.com/ko-kr/windows/win32/api/minwinbase/ns-minwinbase-win32_find_dataa)
        
    파일 탐색 함수를 끝까지 실행하고 나서 마지막에 Note() 함수 호출 → 랜섬노트 출력
    
- 키 생성 함수 확인
    Hazard 클래스의 Hazard 함수에 GEN_AES_KEY함수, GEN_RSA_PUBLIC_KEY 함수가 존재함.
    ⇒ 이 두 개의 함수가 각각 AES, RSA 암호화에 사용되는 키를 생성하는 함수로 추정
    
    ```c
    __int64 __fastcall Hazard::GEN_AES_KEY(BCRYPT_ALG_HANDLE *this)
    {
      __int64 result; // rax
    
      *(_DWORD *)this = 0;
      memset((char *)this + 4, 0, 0x10ui64);
      memset((char *)this + 20, 0, 0x20ui64);
      *(_DWORD *)this = BCryptGenRandom(this[9], (PUCHAR)this + 4, 0x10u, 1u);
      if ( *(int *)this < 0 )
      {
        text_87("Error code : %x\\nBcryptGenRandom fail...\\n", *(unsigned int *)this);
        Hazard::CleanUp(this);
        exit(1);
      }
      *(_DWORD *)this = BCryptGenRandom(this[9], (PUCHAR)this + 20, 0x20u, 1u);
      result = *(unsigned int *)this;
      if ( (int)result < 0 )
      {
        text_87("Error code : %x\\nBcryptGenRandom fail...\\n", *(unsigned int *)this);
        Hazard::CleanUp(this);
        exit(1);
      }
      return result;
    }
    ```
    
    ```c
    void *__fastcall Hazard::GEN_RSA_PUBLIC_KEY(Hazard *this)
    {
      __int64 v1; // rax
    
      *((_QWORD *)this + 7) = malloc(0x21Cui64);
      if ( !*((_QWORD *)this + 7) )
      {
        text_87("Error code : Memory allocation fail...\\n");
        Hazard::CleanUp(this);
        exit(1);
      }
      **((_DWORD **)this + 7) = 826364754;
      *(_DWORD *)(*((_QWORD *)this + 7) + 4i64) = 4096;
      *(_DWORD *)(*((_QWORD *)this + 7) + 8i64) = 3;
      *(_DWORD *)(*((_QWORD *)this + 7) + 12i64) = 512;
      *(_DWORD *)(*((_QWORD *)this + 7) + 16i64) = 0;
      *(_DWORD *)(*((_QWORD *)this + 7) + 20i64) = 0;
      v1 = *((_QWORD *)this + 7) + 24i64;
      *(_WORD *)v1 = e;
      *(_BYTE *)(v1 + 2) = byte_40B086;
      return memcpy((void *)(*((_QWORD *)this + 7) + 27i64), &n, 0x200ui64);
    }
    ```
    
- 파일 암호화 함수 확인
    
    GET_ALG_HANDLE → RNG, AES, RSA 알고리즘 핸들 생성 함수
    GET_KEY_HANDLE → Key Handle 생성 함수 → RSA & AES Key Handle을 생성
    GEN_RSA_PUBLIC_KEY → RSA 공개키 Blob 생성 함수
    GEN_AES_KEY → 랜덤한 IV & AES-256 Key 생성 함수
    
    ---
    
    Files → dir을 탐색하여 암호화 Target 파일을 찾는 함수
    Encrypt → Target 파일을 암호화하는 함수
    Note → 랜섬노트 출력 함수
    
    ---
    
    CleanUp → class 멤버 변수 초기화 함수
    Operate → 랜섬웨어 동작 함수
    
    **파일 암호화 과정**
    
    1. Files 함수 실행
    2. dir을 탐색하여 암호화 타겟 파일을 탐색 (BFS file search in directory)
    3. 디렉토리 check
    4. 파일 확장자 check
    5. Target file 암호화
    6. Note 함수를 실행하여 해당 파일들이 있는 폴더에 랜섬노트 출력

## 2025 랜섬웨어 제작
 > [!example]- 랜섬웨어 구상도 (최종)![[KakaoTalk_20250114_180032246.png]]

--- 
**2주차 과제 (1/14)**
[CNG 과제 1번 (48 Byte 난수 생성)](file:///c%3A/Users/rkdwl/source/repos/FaS%20Program/FaS%20Program/CNG_RNG.cpp)
[CNG 과제 2번 (AES128/CBC/PKCS7Padding 암호화)](file:///c%3A/Users/rkdwl/source/repos/FaS%20Program/FaS%20Program/CNG_AES_Encrypt.cpp)
[CNG 과제 3번 (AES128/CBC/PKCS7Padding 복호화)](file:///c%3A/Users/rkdwl/source/repos/FaS%20Program/FaS%20Program/CNG_AES_Decrypt.cpp)

---
**3주차 과제 (1/21)**
[CNG 과제 4번 (RSA 4096 암호화)](file:///c%3A/Users/rkdwl/source/repos/FaS%20Program/FaS%20Program/CNG_RSA_Encrypt.cpp)
[CNG 과제 5번 (RSA 4096 복호화)](file:///c%3A/Users/rkdwl/source/repos/FaS%20Program/FaS%20Program/CNG_RSA_Decrypt.cpp)
[파일탐색 과제 (현재 디렉터리 내의 모든 파일명 출력)](file:///c%3A/Users/rkdwl/source/repos/FaS%20Program/FaS%20Program/File_Search.cpp)

---
**담당 코드 (1/30) -> 최종 수정 완료 (2/4)**
- RSA4096 PublicKey로 IV와 KEY를 암호화하여 EncryptedIV와 EncryptedKey에 저장
- 암호화된 데이터 = CIPHER || EncryptedKEY || EncryptedIV 파일 이름은 [원본파일이름].cry, 원본 파일은 삭제
[담당 전체 소스코드](file:///c%3A/Users/rkdwl/source/repos/FaS%20Program/Ransom/jihyun.cpp)

>[!example]- 실행 결과
>실행 이전![[image 4.png]]
>실행 이후
>-> 코드가 정상적으로 실행✅![[image 5.png]]
>-> sample_text.txt의 확장자가 .cry로 변경됨✅
>-> HxD로 확인한 결과 알 수 없는 16진수 값들로 변경됨✅
>-> CIPHER 뒤에 EncryptedKEYIV가 정상적으로 추가됨✅![[image 6.png]]

---
**랜섬웨어 복호화 도구 제작
* 파일 확장자가 .cry로 되어 있는 파일을 전부 찾아 Decrypt 함수에 전달
* Decrypt 함수에서는 파일 경로를 받아 하위 512byte를 떼어 RSA 4096으로 복호화, 그 중 상위 32byte를 AES의 키로 설정
* 복호화된 파일은 확장자를 빼고 저장, 확장자는 시그니처를 보고 정해서 저장
[전체 소스코드](file:///c%3A/Users/rkdwl/source/repos/FaS%20Program/Ransom/Decrypt.cpp)

>[!example]- 실행 결과
>실행 이전: 파일이 암호화되어 있는 상태![[image.png]]
>실행 이후
>-> 잘 돌아가는 것을 확인함✅![[image 1.png]]
>-> HxD로 열어보니 정상적으로 텍스트가 복호화됨✅![[image 2.png]]

--- 
**최종 결과물**
![[Ransomware.zip]]

