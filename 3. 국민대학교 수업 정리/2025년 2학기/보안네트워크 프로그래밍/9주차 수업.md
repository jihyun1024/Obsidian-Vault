---
tags:
  - Programming
  - 3학년_2학기
title: 멀티 프로세스 프로그래밍
---
## 학습 주제
1. 프로세스
2. 병렬 처리 기법 (fork, pthread)
3. 멀티스레드 TCP/IP 통신

---
## 연관 수업
[[운영체제_1주차_목요일]]
[[운영체제_4주차_목요일]]

---
## 강의 요약
### 프로세스
[[운영체제]] 강의에서도 공부했듯이, **프로세스**란 실행 중인 프로그램을 의미하며, 더 정확히는 프로그램이 메모리에 저장되어 CPU에서 실행되기 시작하면 프로세스가 된다. 

프로세스의 구성 요소는 다음의 4가지로 분류된다. 

- 코드(Code): 실행 명령어 영역
- 데이터(Data): 전역/정적 변수
- 스택(Stack): 함수 호출, 지역 변수
- 힙(Heap): 동적 메모리 영역

코드 영역은 프로그램을 구성하는 명령어가 저장되는 영역으로, 실행 중 명령어가 변경되면 곤란하기 때문에 읽기 전용(Read-Only)으로 관리된다. 또한 동일 프로그램을 기반으로 여러 프로세스가 생성되면 각각의 프로세스는 같은 코드 영역을 공유해 실행할 수 있어 메모리를 더 효율적으로 사용할 수 있다. 즉, 코드 자체는 같지만 각 프로세스는 **독립된 실행 흐름을 가진다.**

데이터 영역은 프로그램이 사용하는 전역 변수 또는 정적 변수들이 저장되어 있는 공간으로, 프로그램 실행이 시작될 때 할당되어 종료 시까지 유지된다. 변수를 선언할 때 `int a = 10`처럼 초기값을 미리 지정해 저장하는 경우도 존재하며, 전역/정적 변수 영역에 초기값 없이 선언한 변수도 값은 미정인 상태로 존재한다. 데이터 영역의 변수는 **프로그램 전체에서 접근 가능하며, 해당 프로그램이 종료될 때까지 사라지지 않는다.**

스택 영역은 함수 호출 시 필요한 지역 변수, 매개변수, 반환 주소 등을 저장하는 공간으로, 함수가 호출되면 스택 프레임이 생성되고 함수 종료 시 자동으로 제거되므로 별도의 관리가 필요하지 않다. 구조의 특성 상 LIFO 방식으로 동작해 가장 최근에 호출된 함수가 먼저 종료된다. 
스택은 일반적으로 크기가 제한적이므로 **재귀 호출을 너무 많이 사용하거나 매우 큰 지역 변수를 선언하면 스택 오버플로우가 발생할 수 있다.**

힙 영역은 프로그램 실행 중 `calloc`, `malloc`, `realloc` 등의 동적 메모리 할당으로 할당된 메모리를 관리하는 공간으로, `free()`를 호출해 명시적으로 해제해 주지 않으면 메모리 누수가 발생해 장시간 실행되는 프로그램의 경우 성능 저하 또는 시스템 문제로 이어질 수 있다. 
힙은 메모리 크기가 고정된 스택과 달리 상황에 따라 유연하게 늘어나거나 줄어들 수 있어 **동적 자료구조(연결 리스트, 트리 등)에 적합하다.**

![[Pasted image 20251106103623.png]]

한편, 컴파일 과정을 정리하면 다음 사진과 같으며, 
![[Pasted image 20251106103312.png]]

Linux에서는 `ps` 또는 `ps -ef` 명령어 등을 통해 프로세스의 상태를 확인할 수 있고, `kill <PID>` 명령어를 통해 특정 프로세스를 종료시킬 수 있다. 

Windows에서는 cmd에서 `tasklist` 명령어를 통해 프로세스를 확인할 수 있고, 작업 관리자를 통해서도 프로세스를 확인 및 종료시킬 수 있다.

### 병렬 처리 기법 (fork, pthread)
서버는 여러 클라이언트가 동시에 접속해서 요청을 전달하는 환경에서 동작하기 때문에 동시성을 구현하는 프로그래밍이 필수적이다. 

예를 들어 웹 서버의 경우, 동시에 수백, 수천 명의 사용자가 요청을 보내는데 한 번에 하나씩만 처리한다면 특정 요청이 처리되는 동안 다른 사용자는 계속 대기해 시스템의 성능이 저하될 것이다.

따라서, 동시에 실행되는 여러 흐름을 관리하기 위해 OS에서 기본으로 제공하는 기능인 **프로세스/스레드 기반 병렬 처리**가 활용되며, 이를 통해 다수의 사용자 요청을 동시에 처리하고, 응답 지연 감소, 자원 활용 효율 개선, 시스템 확장성 개선 등 다양한 장점을 얻을 수 있다. 

이를 위해서는 하나의 프로그램이 실행되는 과정에서 여러 개의 프로세스를 생성해 동시에 작업을 수행하는 방식인 **멀티 프로세싱**에 대해 알아야 한다. 이는 장단점이 모두 존재한다. 

- 장점
	- 독립된 메모리를 사용하므로 한 프로세스의 오류가 다른 프로세스에 전파되지 않음
	- 기본적으로 메모리를 공유하지 않아 외부 침투나 데이터 훼손이 어려움
- 단점
	- 독립성을 유지하기 때문에 데이터를 주고받기 위해 파이프, 메시지 큐, 공유 메모리 등 별도의 수단이 필요함
	- 새로운 프로세스를 생성하기 위해서는 그만큼의 메모리 공간이 추가적으로 필요함
	- 여러 프로세스를 번갈아 실행할 때 Context Switch가 일어나 오버헤드가 발생함

멀티 프로세싱에서 쓰이는 함수는 `fork`가 있으며, 이 함수는 [[운영체제_3주차_화요일]] 수업에서의 설명을 참고하자. 

멀티 프로세싱의 단점 중 하나인 Context switch로 인한 과도한 오버헤드를 보완하기 위해 **멀티 스레딩** 기법이 함께 활용된다. 
**Thread**란 프로세스 내부에서 실행되는 작업 흐름의 최소 단위로, Thread들은 같은 프로세스에 속해 있어 Code, Data, Heap 영역을 공유하기 때문에 데이터를 서로 빠르게 주고받을 수 있다. 

이것도 장단점이 모두 존재한다. 

- 장점
	- 기존의 프로세스 내에서 생성되기 때문에 별도의 메모리 공간을 만들 필요가 없어 프로세스 생성보다 가벼움
	- 같은 프로세스의 메모리를 함께 사용하므로 IPC 없이도 값을 공유할 수 있음
	- 다수의 작업을 빠르게 처리할 수 있어 I/O 중심 프로그램에서 유리함
- 단점
	- 여러 스레드는 동시에 같은 데이터에 접근할 수 있어 Race condition이 발생 가능
	- 하나의 프로세스의 자원을 공유하기 때문에 특정 스레드에서 문제가 생기면 전체 프로세스가 비정상적으로 종료될 수 있음

멀티 스레딩을 구현하는 `pthread`와 Race condition에 대한 설명은 다음 강의를 참고하자. 

[[운영체제_4주차_목요일]]: `pthread` 관련 설명
[[운영체제_7주차]]: Race Condition 관련 설명
[[운영체제_9주차_화요일]] : Mutex 관련 설명

### 멀티스레드 TCP/IP 통신
TCP 기반 멀티 스레드 서버-클라이언트 통신 구조를 이해하고, 스레드의 동시성과 네트워크 입출력의 흐름을 학습하기 위한 예제 프로그램으로 다음과 같은 코드를 짜 볼 것이다. 

- 구성
	- `thread_serv.c`: 멀티스레드 기반 TCP 서버
	- `thread_cli.c`: 8개의 스레드를 생성해 서버에 동시에 접속하는 클라이언트
- 프로그램 동작
	- 각 클라이언트 연결마다 독립된 스레드가 서버에서 생성
	- 각 클라이언트는 8개의 스레드를 생성
	- 각 스레드는 서버와 독립적으로 연결된 후, 1~5초 사이 랜덤한 시간 동안 대기 후 메시지
	- 서버는 메시지를 수신하고 'ACK' 응답 확인
	- 클라이언트 스레드는 서버 응답 수신 및 출력 후 종료
	- 서버 스레드는 `pthread_detach()`로 자동 해제
	- 클라이언트 스레드는 `pthread_join()`으로 종료 대기

이를 구현한 결과는 다음 사진들과 같다. 
![[Pasted image 20251106110808.png]]
![[Pasted image 20251106110826.png]]
![[Pasted image 20251106110842.png]]
![[Pasted image 20251106110856.png]]


![[Pasted image 20251106110921.png]]

---
## 중요한 단어
1. 프로세스
2. 프로세스/스레드 기반 병렬 처리
3. 멀티 프로세싱
4. 스레드
5. 멀티 스레딩
