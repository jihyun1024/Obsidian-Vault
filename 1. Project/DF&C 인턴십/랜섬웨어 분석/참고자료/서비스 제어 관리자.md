- [[#서비스 제어 관리자의 주요 역할|서비스 제어 관리자의 주요 역할]]
- [[#구성 요소|구성 요소]]
- [[#관련 명령어|관련 명령어]]
- [[#예시: 서비스 시작 흐름|예시: 서비스 시작 흐름]]
- [[#OpenSCManagerA 함수 개요|OpenSCManagerA 함수 개요]]
	- [[#OpenSCManagerA 함수 개요#주요 매개변수|주요 매개변수]]
	- [[#OpenSCManagerA 함수 개요#반환값|반환값]]
- [[#서비스 제어 관리자와 보안|서비스 제어 관리자와 보안]]
- [[#랜섬웨어와의 관련성|랜섬웨어와의 관련성]]
- [[#방어 전략|방어 전략]]

SCM(Service Control Manager, 서비스 제어 관리자)은 Windows 운영 체제에서 서비스와 드라이버를 관리하는 핵심 구성 요소로, 시스템 부팅 시 시작되어 서비스의 시작, 중지, 일시 중지, 재개 등을 제어하며, 서비스 관련 이벤트를 처리하고 로그를 기록한다. 

### 서비스 제어 관리자의 주요 역할
1. 서비스 등록 및 관리
	1. 서비스는 sc.exe 또는 `CreateService()`API를 통해 SCM에 등록된다. 
	2. SCM은 서비스의 메타데이터(이름, 경로, 시작 유형 등)를 [[레지스트리]]에 저장한다. 
2. 서비스 시작 및 중지
	1. 시스템 부팅 시 자동으로 시작하는 서비스들을 로드한다. 
	2. 사용자가 `net start`, `net stop`등의 명령어나 API를 통해 서비스를 제어할 수 있다.
3. 종속성 관리
	1. 서비스 간의 종속 관계를 관리하며, 필요한 서비스가 먼저 시작되도록 한다.
4. 보안 및 권한 제어
	1. 서비스에 대한 접근 권한을 관리하고 제어한다.
	2. 서비스는 특정 사용자 계정으로 실행된다. 
5. 이벤트 로깅
	1. 서비스 상태 변경, 오류 등을 이벤트 로그에 기록한다. 

### 구성 요소
| 구성 요소                  | 설명                                                                                               |
| ---------------------- | ------------------------------------------------------------------------------------------------ |
| `services.exe`         | SCM의 실행 파일. Windows가 부팅되면 자동으로 시작됨.                                                              |
| `Service Control APIs` | `OpenSCManager`, `CreateService`, `StartService`, `ControlService` 등 API를 통해 프로그래밍적으로 서비스 제어 가능. |
| `SCM Database`         | 서비스 정보가 저장된 레지스트리 경로: `HKLM\SYSTEM\CurrentControlSet\Services`                                   |
| `Service Dispatcher`   | 각 서비스 프로세스 내에서 SCM과 통신하는 루틴. `StartServiceCtrlDispatcher()` 호출로 시작됨.                             |

### 관련 명령어
- `sc query` : 서비스 상태 조회
- `sc start [서비스명]` : 서비스 시작
- `sc stop [서비스명]` : 서비스 중지
- `sc config [서비스명] start= auto` : 자동 시작 설정
- `net start [서비스명]` / `net stop [서비스명]` : 간단한 서비스 제어 (시작/중지)

### 예시: 서비스 시작 흐름
1. 사용자가 `sc start ExampleService`를 실행
2. SCM은 레지스트리에서 `ExampleService`서비스의 경로 조회
3. 종속 서비스가 있는 경우, 해당 종속 서비스를 먼저 시작
4. `ExampleService`의 실행 파일을 로드하고 `StartServiceCtrlDispatcher()`호출
5. SCM은 `SERVICE_START_PENDING`상태에서 `SERVICE_RUNNING`상태로 전환

### OpenSCManagerA 함수 개요
```cpp
SC_HANDLE OpenSCManagerA(
  LPCSTR lpMachineName,
  LPCSTR lpDatabaseName,
  DWORD  dwDesiredAccess
);
```
#### 주요 매개변수
* `lpMachineName`: 원격 컴퓨터 이름
* `lpDatabaseName`: 서비스 데이터베이스 이름 (일반적으로 `"ServicesActive"`사용)
* `dwDesiredAccess`: 접근 권한
#### 반환값
* 실패 시: `NULL`반환, `GetLastError()`로 오류 코드 확인 가능
* 성공 시: SCM 핸들 (`SC_HANDLE`)

### 서비스 제어 관리자와 보안
SCM은 시스템의 핵심 서비스를 관리하기 때문에 권한이 높은 작업을 수행할 수 있다. 따라서 `OpenSCManagerA`를 호출할 때 요청하는 접근 권한(`dwDesiredAccess`)의 수준에 따라 관리자 권한이 필요할 수도 있다. 
예를 들어:
- `SC_MANAGER_CREATE_SERVICE`: 새로운 서비스를 등록할 수 있는 권한
- `SC_MANAGER_ALL_ACCESS`: 모든 서비스 관리 작업 가능

### 랜섬웨어와의 관련성
랜섬웨어나 기타 악성코드는 `OpenSCManagerA`를 악용해 시스템에 악성 서비스를 등록하거나 기존 서비스를 조작할 수 있다. 아래는 그 예시이다. 
1. 악성 서비스 등록
	1. 랜섬웨어는 `OpenSCManagerA` → `CreateService` → `StartService` 순으로 악성 서비스를 등록하고 실행할 수 있다. 
	2. 등록한 서비스는 시스템 부팅 시 자동으로 시작하도록 설정할 수 있어 지속성 확보에 사용된다.
2. 보안 우회
	1. SCM을 통해 실행되는 서비스는 종종 `SYSTEM`권한을 가지게 되기 때문에, 악성코드가 이 경로를 통해 실행되면 **권한 상승(Privilege escalation)** 이 발생할 수 있다.
	2. 권한 상승이 발생할 경우 관리자 권한으로 들어갈 수 있는 정보에 액세스할 수 있다.
3. 탐지 회피
	1. 일반적인 프로세스보다 서비스는 보안 솔루션의 감시를 덜 받는 경우가 있기 때문에 랜섬웨어가 SCM을 통해 실행되면 탐지 회피에 유리할 수 있다. 

### 방어 전략
1. 서비스 등록 모니터링
	*  `OpenSCManagerA`, `CreateService` API 호출을 감시하는 보안 솔루션 사용
2. 권한 제한
	- 일반 사용자에게 SCM 접근 권한 제한
3. 레지스트리 및 서비스 변경 감시
	-  `HKLM\SYSTEM\CurrentControlSet\Services` 경로의 변경 사항 실시간 감시