
# λ©μ°¨
- [[#λ™μ‘ λ¶„μ„ Warm-Up|λ™μ‘ λ¶„μ„ Warm-Up]]
- [[#μ‚¬μ©μμ κµ­κ°€ ν™•μΈ (κµ¬μ†λ ¨μΌ κ²½μ°, λ„μ–΄κ°)|μ‚¬μ©μμ κµ­κ°€ ν™•μΈ (κµ¬μ†λ ¨μΌ κ²½μ°, λ„μ–΄κ°)]]
- [[#ν”Όν•΄ μ»΄ν“¨ν„°μ μ •λ³΄ μμ§‘|ν”Όν•΄ μ»΄ν“¨ν„°μ μ •λ³΄ μμ§‘]]
	- [[#ν”Όν•΄ μ»΄ν“¨ν„°μ μ •λ³΄ μμ§‘#ragnar_locker.5931D0 ν•¨μ λ¶„μ„ (2λ² μν–‰, λ‚μ μƒμ„±)|ragnar_locker.5931D0 ν•¨μ λ¶„μ„ (2λ² μν–‰, λ‚μ μƒμ„±)]]
	- [[#ν”Όν•΄ μ»΄ν“¨ν„°μ μ •λ³΄ μμ§‘#ragnar_locker.5920E0 ν•¨μ λ¶„μ„ (2λ² μν–‰, RC4 λ³µνΈν™”)|ragnar_locker.5920E0 ν•¨μ λ¶„μ„ (2λ² μν–‰, RC4 λ³µνΈν™”)]]
- [[#λ³Όλ¥¨ μ„€λ„ λ³µμ‚¬λ³Έ μ‚­μ |λ³Όλ¥¨ μ„€λ„ λ³µμ‚¬λ³Έ μ‚­μ ]]
- [[#κ³µκ°ν‚¤ λ³µνΈν™”|κ³µκ°ν‚¤ λ³µνΈν™”]]
- [[#λμ„¬λ…ΈνΈ μ μ‘|λμ„¬λ…ΈνΈ μ μ‘]]
- [[#νμΌ νƒμƒ‰ λ° μ•”νΈν™” μν–‰|νμΌ νƒμƒ‰ λ° μ•”νΈν™” μν–‰]]
- [[#μ•…μ„± ν–‰μ„κ°€ λλ‚ μ΄ν›„|μ•…μ„± ν–‰μ„κ°€ λλ‚ μ΄ν›„]]
- [[#λ” μμ„Έν•κ³  μ¶”κ°€μ μΈ λ¶„μ„|λ” μμ„Έν•κ³  μ¶”κ°€μ μΈ λ¶„μ„]]

## λ™μ‘ λ¶„μ„ Warm-Up
x64dbgμ— λΌκ·Έλ‚λ΅μ»¤ λμ„¬μ›¨μ–΄λ¥Ό λ¬Όλ ¤ λ†“κ³  F9 ν‚¤λ¥Ό 3λ² μ •λ„ λ„λ¥΄λ©΄ [[ν•¨μ ν”„λ΅¤λ΅κ·Έ & μ—ν•„λ΅κ·Έ|ν•¨μ ν”„λ΅¤λ΅κ·Έ]]λ¥Ό λ°κ²¬ν•  μ μλ‹¤. 
```
push ebx
mov ebx, esp
sub esp, 8
```
μ΄μ  [[x64dbg μ‚¬μ© λ°©λ²•]]μ—μ„ λ³Έ κ²ƒμ²λΌ μ¤‘λ‹¨μ μ„ μ°κ³ , ν• μ¤„μ”© λ‚΄λ ¤κ°€λ©΄μ„ μƒλ΅μ΄ ν•¨μκ°€ λ³΄μ΄λ©΄ μ¤‘λ‹¨μ μ„ μ°κ³ , κ·Έ μ•μΌλ΅ λ“¤μ–΄κ°€κ±°λ‚ ν•λ©΄μ„ λ¶„μ„ν•΄ λ³΄μ. 
κ·Έ μ „μ—, ν•¨μλ΅ μ–΄λ–¤ μΈμλ¥Ό λ„£λ”μ§€ ν™•μΈν•λ” λ°©λ²•μ€ [[x64dbg μ‚¬μ© λ°©λ²•#π‘¨β€π”§μ¤νƒμ„ ν™μ©ν• ν•¨μμ Parameter ν™•μΈ λ°©λ²•|μ¤νƒμ„ ν™μ©ν• ν•¨μμ Parameter ν™•μΈ]]μ—μ„ λ³Ό μ μλ‹¤. 

κ·Έ μ „μ—, μ°λ¦¬κ°€ λ„μ–΄κ°”λ`ntdll.dll`μ€ λμ„¬μ›¨μ–΄ λ“±μ μ•…μ„±μ½”λ“μ—μ„ λ‹¤μ μ΄μ λ΅ μ‚¬μ©ν•λ‹¤. 
1. **νƒμ§€ μ°ν**
	λ³΄ν†µ μ •μƒμ μΈ μ• ν”λ¦¬μΌ€μ΄μ…μ€ `kernel32.dll`μ΄λ‚ `user32.dll` λ“±μ κ³ μμ¤€ APIλ¥Ό μ‚¬μ©ν•λ‹¤. 
	κ·Έλ¬λ‚ μ•…μ„±μ½”λ“λ” λ³΄μ• μ†”λ£¨μ…μ κ³ μμ¤€ API κ°μ‹λ¥Ό ν”Όν•κΈ° μ„ν•΄ `ntdll.dll` λ“±μ Native APIλ¥Ό μ§μ ‘ νΈμ¶ν•λ‹¤. 
2. **λ©”λ¨λ¦¬ μ΅°μ‘ λ° μΈμ μ…**
	μ•…μ„±μ½”λ“λ” μΆ…μΆ… λ‹¤λ¥Έ ν”„λ΅μ„Έμ¤λ¥Ό ν†µμ ν•κΈ° μ„ν•΄ `ntdll.dll`μ ν•¨μλ¥Ό μ‚¬μ©ν•λ‹¤.
	- `NtAllocateVirtualMemory`: λ©”λ¨λ¦¬ κ³µκ°„ ν™•λ³΄
	- `NtWriteVirtualMemory`: λ©”λ¨λ¦¬μ— μ•…μ„± μ½”λ“ μ“°κΈ°
	- `NtCreateThreadEx`: μ›κ²© μ¤λ λ“ μƒμ„± (μ½”λ“ μ‹¤ν–‰)
	μ΄λ° λ°©μ‹μ€Β **DLL μΈμ μ…**,Β **Reflective DLL Injection**,Β **Process Hollowing**Β κ°™μ€ κΈ°μ μ— μ‚¬μ©λλ‹¤.
3. **Hook μ°ν λ° API ν¨μΉ νƒμ§€**
	λ³΄μ• μ†”λ£¨μ…μ€ μΆ…μΆ… κ³ μμ¤€ APIμ— API Hookingμ„ κ±Έμ–΄ μ•…μ„± ν–‰μ„λ¥Ό νƒμ§€ν•λ‹¤. κ·Έλ¬λ‚ `ntdll.dll`μ Native APIλ” μƒλ€μ μΌλ΅ λ κ°μ‹λκΈ° λ•λ¬Έμ— μ•…μ„±μ½”λ“λ” μ΄λ¥Ό ν†µν•΄ API Hookingμ„ μ°νν•λ‹¤. 
	- `NtQuerySystemInformation`μ„ μ‚¬μ©ν•΄ μ‹μ¤ν… μ •λ³΄λ‚ ν”„λ΅μ„Έμ¤ λ¦¬μ¤νΈλ¥Ό κ°€μ Έμ™€ λ³΄μ• μ†”λ£¨μ…μ„ νƒμ§€ν•  μ μμ
	- `NtProtectVirtualMemory`λ¥Ό μ‚¬μ©ν•΄ λ©”λ¨λ¦¬ λ³΄νΈ μ†μ„±μ„ λ³€κ²½ν•μ—¬ νƒμ§€ νν”Ό
4. **Syscall μ§μ ‘ νΈμ¶**
	κ³ κΈ‰ μ•…μ„±μ½”λ“λ” `ntdll.dll`μ„ κ±°μΉμ§€ μ•κ³  μ§μ ‘ μ‹μ¤ν… νΈμ¶μ„ μν–‰ν•κΈ°λ„ ν•λ‹¤. ν•μ§€λ§ λ€λ¶€λ¶„μ μ•…μ„±μ½”λ“λ” `ntdll.dll`μ ν•¨μμ—μ„ Syscall λ²νΈλ¥Ό μ¶”μ¶ν•΄ μ΄λ¥Ό κΈ°λ°μΌλ΅ μ§μ ‘ νΈμ¶ν•λ‹¤. 
	μ΄λ” λ³΄μ• μ†”λ£¨μ…μ΄ `ntdll.dll`μ„ λ¨λ‹ν„°λ§ν•λ”λΌλ„ νƒμ§€ν•μ§€ λ»ν•κ² ν•λ‹¤. 

λ‹¤μ‹ λμ•„κ°€μ„, λμ„¬μ›¨μ–΄λ¥Ό λ™μ  λ¶„μ„ν•΄ λ³΄μ. 
λ¨Όμ € μ­‰ λ‚΄λ ¤κ°€λ‹¤κ°€ `call ragnar_locker.5974C0`λΌλ” ν•¨μλ¥Ό λ§λ‚  μ μκ³ , κ·Έ κ³³μ— μ¤‘λ‹¨μ μ„ μ°κ³  F7μ„ λλ¬ κ·Έ ν•¨μλ΅ λ“¤μ–΄κ°€ λ¶„μ„ν•΄ λ³΄μ. ![[Pasted image 20250726134518.png]]
κ·Έλ¬λ©΄, λ‹¤μκ³Ό κ°™μ΄ κ·Έ λ°‘μ— λ£¨ν”„κ°€ μλ” κ²ƒμ„ λ°κ²¬ν•  μ μλ”λ°, μ΄ λ£¨ν”„λ” μ•½ 3λ² μ •λ„ λλ‹¤κ°€ λ°©κΈ μ¤‘λ‹¨μ μ„ μ„¤μ •ν•΄ λ†“μ€ κ·Έ κ³³ λ°”λ΅ λ°‘μΌλ΅ λΉ μ Έλ‚μ¤λ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤. 
μ΄ν›„ `push esi, push edi`λ¥Ό μ‚¬μ©ν•΄ λ°μ΄ν„°μ μ£Όμ†μ™€ λ©μ μ§€μ μ£Όμ†λ¥Ό μ¤νƒμ— μ €μ¥ν•κ³  λ‚μ„ `call ragnar_locker.591CF0` λ…λ Ήμ–΄λ¥Ό μ‚¬μ©ν•΄ ν•΄λ‹Ή ν•¨μλ΅ λ„μ–΄κ°„λ‹¤. 

![[Pasted image 20250726134659.png]]
κ·Έλ¬λ©΄ μ΄λ ‡κ² μ—„μ²­λ‚κ² λ§μ€ κ·€μ°®μ€ μ½”λ“κ°€ μλ”λ°, λ¶„κΈ°λ‚ ν•¨μ νΈμ¶ λ“± μλ―Έμλ” μ½”λ“κ°€ λ‚μ¬ λ•κΉμ§€ κ³„μ† F8μΌλ΅ λ„μ–΄κ°€ λ³΄μ. 
κ³„μ† λ„μ–΄κ°€κ³  λ λ„μ–΄κ°€ λ³΄λ©΄...

## μ‚¬μ©μμ κµ­κ°€ ν™•μΈ (κµ¬μ†λ ¨μΌ κ²½μ°, λ„μ–΄κ°)
![[Pasted image 20250726134823.png]]
λ‹¤μμ²λΌ [GetLocaleInfow](https://learn.microsoft.com/en-us/windows/win32/api/winnls/nf-winnls-getlocaleinfow)ν•¨μλ¥Ό μ‚¬μ©ν•΄ μ‚¬μ©μμ κµ­κ°€, μ–Έμ–΄ λ“±μ„ λ°›μ•„μ™€ EAX λ μ§€μ¤ν„°μ— μλ¬Έ λ¬Έμμ—΄λ΅ μ €μ¥ν•λ©°, μ΄λ¥Ό λ°λ³µλ¬Έμ„ μ΄μ©ν•΄ μ—¬λ¬ λ‚λΌμ μ–Έμ–΄μ™€ λΉ„κµν•λ‹¤. μ΄λ• λΉ„κµν•λ” μ–Έμ–΄λ” Azerbaijani, Armenian, Belorussian, Kazakh, Kyrgyz, Moldavian, Tajik, Russian, Turkmen, Uzbek, Ukrainian, Georgian μ΄ 12κ°μ΄λ‹¤. (ν•΄λ‹Ή μ–Έμ–΄λ“¤μ€ μ†λ ¨μ μΌλ¶€μ€λ‹¤λ” κ³µν†µμ μ΄ μλ‹¤)
μ΄ν›„ ν•¨μ μ—ν•„λ΅κ·Έλ¥Ό ν†µν•΄ ν•¨μ λ°–μΌλ΅ λ‚κ°„λ‹¤. 

![[Pasted image 20250726135008.png]]
μ΄ν›„ λΌκ·Έλ‚λ΅μ»¤ μ‹μ‘ μ§€μ μΌλ΅ λ‹¤μ‹ λμ•„μ™€ μ»΄ν“¨ν„°μ μ΄λ¦„κ³Ό Usernameμ„ λ°›κ³  λ‹¤μ κ³Όμ •μ„ μν–‰ν•λ‹¤.

## ν”Όν•΄ μ»΄ν“¨ν„°μ μ •λ³΄ μμ§‘
`ragnar_locker.5921C0`ν•¨μλ΅ λ„μ–΄κ°€ λ³΄λ©΄ [VirtualAlloc](https://learn.microsoft.com/ko-kr/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc)ν•¨μλ¥Ό μ‚¬μ©ν•΄ ν„μ¬ ν”„λ΅μ„Έμ¤μ— μ¶”κ°€μ μΈ ν–‰μ„λ¥Ό ν•κΈ° μ„ν• κ°€μƒ λ©”λ¨λ¦¬λ¥Ό ν• λ‹Ήν•λ©°, [RegOpenKeyExW](https://learn.microsoft.com/ko-kr/windows/win32/api/winreg/nf-winreg-regopenkeyexw)ν•¨μλ¥Ό μ΄μ©ν•΄ [[λ μ§€μ¤νΈλ¦¬]]μ ν‚¤λ¥Ό μ—°λ‹¤. 
κ·Έλ¦¬κ³  λ‚μ„ [RegQueryValueExW](https://learn.microsoft.com/ko-kr/windows/win32/api/winreg/nf-winreg-regqueryvalueexw)ν•¨μλ¥Ό μ΄μ©ν•΄ μ—΄μ—λ λ μ§€μ¤νΈλ¦¬ ν‚¤μ™€ μ—°κ΄€λ μ§€μ •λ κ°’/μ΄λ¦„μ— λ€ν• μ ν•κ³Ό λ°μ΄ν„°λ¥Ό κ²€μƒ‰ν•κ³ , [RegCloseKey](https://learn.microsoft.com/ko-kr/windows/win32/api/winreg/nf-winreg-regclosekey)ν•¨μλ¥Ό μ‚¬μ©ν•΄ μ—΄μ—λ λ μ§€μ¤νΈλ¦¬μ ν‚¤λ¥Ό λ‹«λ”λ‹¤. 
![[KakaoTalk_20250805_221734510_01.png]]
μ΄ν›„ ν•΄λ‹Ή μ‘μ—…μ΄ μ „λ¶€ λλ‚λ©΄ μ΄ ν•¨μλ¥Ό νΈμ¶ν•κΈ° μ΄μ „μ λ©”μΈ ν•¨μλ΅ λμ•„κ°€ λ‹¤μ μ½”λ“λ¥Ό μ‹μ‘ν•λ©°, μ΄ν›„μ μ½”λ“μ—μ„ `push eax`κ°€ μ‹¤ν–‰λ  λ•λ§λ‹¤ κ°κ° μ‚¬μ©μμ μ΄λ¦„(USERNAME), μ»΄ν“¨ν„°μ μ΄λ¦„μ΄ EAX λ μ§€μ¤ν„°κ°€ κ°€λ¦¬ν‚¤λ” μ£Όμ†μ κ°’μ— pushλλ” κ²ƒμ„ ν™•μΈν•  μ μμ—λ‹¤. 
![[KakaoTalk_20250805_221734510.png]]

μ΄μ `ragnar_locker.592240` ν•¨μλ¥Ό μ‹¤ν–‰ν•΄ λ³΄μ. μ¤ν¬λ¦°μƒ·μ—μ„λ„ λ³΄μ΄λ“―μ΄ esi λ μ§€μ¤ν„°κ°€ κ°€λ¦¬ν‚¤λ” λ©”λ¨λ¦¬ μ£Όμ†μ κ°’μ—λ” ν„μ¬ Windows λ²„μ „μ΄, eax λ μ§€μ¤ν„°κ°€ κ°€λ¦¬ν‚¤λ” λ©”λ¨λ¦¬ μ£Όμ†μ κ°’μ—λ” μ»΄ν“¨ν„°μ μ΄λ¦„μ΄, edi λ μ§€μ¤ν„°κ°€ κ°€λ¦¬ν‚¤λ” λ©”λ¨λ¦¬ μ£Όμ†μ κ°’μ—λ” μ‹λ¦¬μ–Ό μ½”λ“ λΉ„μ·ν• λ¬Έμμ—΄μ΄ κ°κ° λ³΄μ΄λ” κ²ƒμ„ ν™•μΈν–λ‹¤. 
μ΄ μ½”λ“μ—μ„λ” μ•μ„ λ‚μ™”λ VirtualAlloc ν•¨μμ™€`lstrlenW` ν•¨μ, `wsprintfW`ν•¨μκ°€ μ‚¬μ©λμ—λ”λ°, μ΄λ” κ°κ° μ§€μ •λ λ¬Έμμ—΄μ κΈΈμ΄λ¥Ό κ²°μ •ν•κ³ , μ§€μ •λ λ²„νΌμ— μ„μ‹μ΄ μ§€μ •λ λ°μ΄ν„°λ¥Ό μ“°λ” ν•¨μμ΄λ‹¤. 
![[Pasted image 20250726140128.png]]
λ”°λΌμ„ `ragnar_locker.592240` ν•¨μλ” `lstrlenW`ν•¨μλ΅ μ…λ ¥λ λ¬Έμμ—΄μ κΈΈμ΄λ¥Ό κ³„μ‚°ν•κ³ , λ£¨ν”„μ—μ„ μ •μλ λ°λ³µλ¬Έλ€λ΅ μ›€μ§μ΄λ©° κ°„λ‹¨ν• ν•΄μ‹κ°’μ΄λ‚ λ¬΄κ²°μ„± μ²΄ν¬ λ“±μ μ—°μ‚°μ„ μν–‰ν•λ” ν•¨μλ΅ μ¶”μΈ΅λλ‹¤. 
κ·Έ λ’¤μ—λ„ 4λ² μ •λ„ `ragnar_locker.592240`ν•¨μλ¥Ό λ” μν–‰ν•λ” μ½”λ“κ°€ μμΌλ©°, μ΄ μ½”λ“λ¥Ό μν–‰ν• λ’¤, `wsprintfW`ν•¨μλ¥Ό νΈμ¶ν•΄ ESP λ μ§€μ¤ν„°κ°€ κ°€λ¦¬ν‚¤λ” λ©”λ¨λ¦¬ μ£Όμ†μ κ°’μ— `A6A64009-6FAB6FDA-780E09FA-818CD995-10352210`μ ν•΄μ‹κ°’ λΉ„μ·ν• κ²ƒμ„ μ €μ¥ν•λ‹¤. 
λ” μ •ν™•νλ”, μ»΄ν“¨ν„° μ΄λ¦„, μ‚¬μ©μ μ΄λ¦„, μ»΄ν“¨ν„°μ guid, Windows λ²„μ „, combined_infoμ μμ„λ€λ΅ ν•΄μ‹λ¥Ό κ³„μ‚°ν•΄μ„ μ„μ ν•΄μ‹κ°’μ ν•νƒλ΅ μ €μ¥ν•λ‹¤. (μ¶μ²: https://www.cybereason.com/blog/threat-analysis-report-ragnar-locker-ransomware-targeting-the-energy-sector)
![[Pasted image 20250812175042.png]]
![[Pasted image 20250726140355.png]]

κ·Έ λ°‘μΌλ΅ μλ§μ€ ν•¨μκ°€ μ‚¬μ©λκ³  μλ”, Ragnar Locker λμ„¬μ›¨μ–΄μ—μ„ λ©”μΈ κΈ°λ¥μ„ λ‹΄λ‹Ήν•λ” κ²ƒμ²λΌ λ³΄μ΄λ” μ½”λ“κ°€ λ“±μ¥ν•λ‹¤. ν•λ‚ν•λ‚ λ¶„μ„ν•΄ λ³΄μ.
![[Pasted image 20250726140432.png]]
λ¨Όμ €, [CreateEventW](https://learn.microsoft.com/ko-kr/windows/win32/api/synchapi/nf-synchapi-createeventw), [GetLastError](https://learn.microsoft.com/ko-kr/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror), [GetCurrentProcess](https://learn.microsoft.com/ko-kr/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocess), [TerminateProcess](https://learn.microsoft.com/ko-kr/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess), [CloseHandle](https://learn.microsoft.com/ko-kr/windows/win32/api/handleapi/nf-handleapi-closehandle) ν•¨μλ“¤μ„ μ‚¬μ©ν•κ³ , ν•¨μμ λ°ν™κ°’μ„ νΉμ • κ°’κ³Ό λΉ„κµν•λ” λ°©μ‹μΌλ΅ ν„μ¬ λμ„¬μ›¨μ–΄ ν”„λ΅μ„Έμ¤λ¥Ό κ΄€λ¦¬ν•λ©°,
μ•μ—μ„ κ³„μ‚°ν–λ ν•΄μ‹κ°’μ΄ μ΄μ–΄μ§„ λ¬Έμμ—΄μ„ μ΄λ²¤νΈ μ΄λ¦„μΌλ΅ μ‚¬μ©ν•λ‹¤. 
![[Pasted image 20250813132356.png]]
μ΄ μ‚¬μ§„μ—μ„ 0, 1, 0, ν•΄μ‹κ°’μ„ μΈμλ΅ λ„£μ–΄ μƒ μ΄λ²¤νΈλ¥Ό λ§λ“¤ λ• μ΄λ²¤νΈ μ΄λ¦„μ„ ν•΄λ‹Ή ν•΄μ‹κ°’μΌλ΅ ν•λ‹¤. 
![[Pasted image 20250813133525.png]]

[GetCurrentProcess](https://learn.microsoft.com/ko-kr/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess)ν•¨μλ΅ ν„μ¬ μ‹¤ν–‰ μ¤‘μΈ ν”„λ΅μ„Έμ¤λ“¤μ„ λ°›μ•„ μ™€ [TerminateProcess](https://learn.microsoft.com/ko-kr/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess)ν•¨μλ¥Ό μ‚¬μ©ν•΄ ν„μ¬ μ‹¤ν–‰ μ¤‘μΈ ν”„λ΅μ„Έμ¤λ“¤μ„ κ°•μ λ΅ μ •μ§€ν•λ‹¤. ν•΄λ‹Ή μ‘μ—…μ€`while`λ°λ³µλ¬Έμ„ 0xFAE9κ³Ό λΉ„κµν•λ” λ°©μ‹μΌλ΅ μΈλ±μ¤λ¥Ό 1μ”© λλ ¤ κ°€λ©° (inc esi, cmp esi, FAE9) λ™μ‘ν•λ‹¤.
κ·Έ λ’¤μ— `ragnar_locker.5931D0`μ™€ `ragnar_locker.5920E0` ν•¨μκ°€ 2κ°μ”© λ‚μ¨λ‹¤. 
ν•λ‚μ”© μ•μ•„λ³΄μ. 

---
### ragnar_locker.5931D0 ν•¨μ λ¶„μ„ (2λ² μν–‰, λ‚μ μƒμ„±)
λ¨Όμ € `ragnar_locker.5931D0`ν•¨μλ¥Ό callν•λ” μ§€μ μ— μ¤‘λ‹¨μ μ„ κ±Έκ³  F7μΌλ΅ λ“¤μ–΄κ°€μ„ λ¶„μ„ν•΄ λ³΄λ©΄ κ·Έ μ•μ—μ„λ„ ν•¨μ μ—ν•„λ΅κ·Έ λ¶€λ¶„κΉμ§€ μ—¬λ¬ ν•¨μλ“¤μ„ μ¶”κ°€λ΅ νΈμ¶ν•λ‹¤. 
νΈμ¶ν•λ” ν•¨μλ” λ‹¤μκ³Ό κ°™λ‹¤. 
1. [CryptAcquireContextW](https://learn.microsoft.com/ko-kr/windows/win32/api/wincrypt/nf-wincrypt-cryptacquirecontextw) ν•¨μ: νΉμ • CSP(μ•”νΈν™” μ„λΉ„μ¤ κ³µκΈ‰μ) μ•μ νΉμ • ν‚¤ [[μ»¨ν…μ΄λ„]]μ— λ€ν• ν•Έλ“¤μ„ νλ“ν•λ” λ° μ‚¬μ©ν•λ©°, μ΄ ν•Έλ“¤μ€ μ„ νƒν• CSPλ¥Ό μ‚¬μ©ν•λ” CryptoAPI ν•¨μ νΈμ¶μ— μ‚¬μ©λλ‹¤. ν•΄λ‹Ή ν•¨μλ” [[CNG (Cryptography Next Generation)|CNG]]μ [BCryptOpenAlgorithmProvider ν•¨μ](https://learn.microsoft.com/ko-kr/windows/win32/api/bcrypt/nf-bcrypt-bcryptopenalgorithmprovider)μ™€ λΉ„μ·ν•κ² μ•”νΈν™”, λ‚μ μƒμ„± λ“±μ„ μ„ν• μ¤€λΉ„ λ‹¨κ³„μ— ν•΄λ‹Ήν•λ‹¤.
2. [CryptGenRandom](https://learn.microsoft.com/ko-kr/windows/win32/api/wincrypt/nf-wincrypt-cryptgenrandom) ν•¨μ: μ§€μ •ν• λ²„νΌμ— μ§€μ •ν• λ°”μ΄νΈ μ λ§νΌμ λ‚μλ¥Ό λ„£μ–΄ λ°ν™ν•λ‹¤. 
	1. μ²« λ²μ§Έ μ‹¤ν–‰: 0x28 = 40 Byteλ¥Ό μƒμ„±
	2. λ‘ λ²μ§Έ μ‹¤ν–‰: 0x20 = 32 Byteλ¥Ό μƒμ„±
	![[Pasted image 20250813143025.png]]
3. [CryptReleaseContext](https://learn.microsoft.com/ko-kr/windows/win32/api/wincrypt/nf-wincrypt-cryptreleasecontext) ν•¨μ: CSPμ ν‚¤ μ»¨ν…μ΄λ„μ ν•Έλ“¤μ„ ν•΄μ ν•λ‹¤. μ΄ ν•¨μλ” CNGμ [BCryptCloseAlgorithmProvider ν•¨μ](https://learn.microsoft.com/ko-kr/windows/win32/api/bcrypt/nf-bcrypt-bcryptclosealgorithmprovider)μ™€ λΉ„μ·ν• μ—­ν• μ„ μν–‰ν•λ‹¤. 
4. `ragnar_locker.597240`ν•¨μ
	![[Pasted image 20250805165437.png]]
	λ³„λ„μ ν•¨μ νΈμ¶ μ—†μ΄ EAX λ μ§€μ¤ν„°κ°€ κ°€λ¦¬ν‚¤λ” λ©”λ¨λ¦¬ μ£Όμ†μ— 4λ°”μ΄νΈ κ°’μ„ 16λ², μ΄ 64λ°”μ΄νΈμ κ°’μ„ μ €μ¥ν•λ©°, κ°κ°μ κ°’μ€ μ‚¬μ§„κ³Ό κ°™μ΄ μ‹¤ν–‰νμΌ λ‚΄μ— ν•λ“μ½”λ”© λμ–΄ μμ—λ‹¤. 
5. `ragnar_locker.5972F0`ν•¨μ
	![[Pasted image 20250805165946.png]]
	μ•„μ§ μ–΄μ…λΈ”λ¦¬μ–΄μ— λ€ν• μ΄ν•΄κ°€ μ™„λ²½ν•μ§€ μ•μ•„ μ΄ ν•¨μλ” λ³„ λ‹¤λ¥Έ μ—­ν• μ„ ν•μ§€ μ•λ” ν•¨μμ²λΌ λ³΄μ€λ‹¤. 
6. `ragnar_locker.596F30`ν•¨μ
	μ΄ ν•¨μμ—μ„λ” μ­‰ λ‚΄λ ¤κ°€λ‹¤κ°€ λ‹¤μ‹ μ—¬λ¬ ν•¨μλ“¤μ„ νΈμ¶ν•λ‹¤. 
	![[Pasted image 20250805171032.png]]
	1. `ragnar_locker.593290` ν•¨μ
		![[Pasted image 20250805171542.png]]
		`ret`λ…λ Ήμ–΄λ΅ λ°ν™ν•κΈ° μ „κΉμ§€ `mov, sub, xor, add`λ“±μ μ—°μ‚°μ„ λ§μ΄ μν–‰ν•λ‹¤. 
		λμ„¬μ›¨μ–΄μ— μ΄λ¬ν• μ—°μ‚°μ΄ μλ” κ²ƒμΌλ΅ λ΄μ„ μ–΄λ–¤ μ•”νΈ μ—°μ‚°μ„ μν–‰ν•λ” κ²ƒμ΄ μ•„λ‹κΉ μ¶”μΈ΅λλ‹¤.
	2. `ragnar_locker.5974F0` ν•¨μ (4λ² μν–‰)
		![[Pasted image 20250805191659.png]]
		μ‹¤ν–‰ν•λ©΄ `cmp cl,40`, `cmp cl,20`, `mov eax,edx`, `xor edx,edx`, `and cl,1F`, `shr eax,cl`, `ret`μ λ…λ Ήμ–΄λ¥Ό μμ„λ€λ΅ μν–‰ν•κ³  ν•¨μ λ°–μΌλ΅ λ‚μ¨λ‹¤. 
	3. κ·Έ λ’¤λ΅ `mov` λ…λ Ήμ–΄μ™€ `shr`λ…λ Ήμ–΄ λ‘ κ°λ§μ„ μ‚¬μ©ν•΄ μ—°μ‚°μ„ λ§μ΄ ν• λ’¤ `ret`λ…λ Ήμ–΄λ΅ λ°ν™ν•λ‹¤.
7. `ragnar_locker.597430`ν•¨μ 
	![[Pasted image 20250805193525.png]]
	`push`λ…λ Ήμ–΄μ™€ `mov`, `and`, `rep`, `shr`, `cld`λ…λ Ήμ–΄λ¥Ό μ‚¬μ©ν•΄ κ°„λ‹¨ν• μ—°μ‚°μ„ ν• λ’¤ λ°ν™ν•λ‹¤. 

μ΄ν›„, λ©”μΈ ν•¨μλ΅ λ‚μ™€μ„ `push`λ…λ Ήμ–΄λ΅ λ“¤μ–΄κ°”λ λ©”λ¨λ¦¬ μ£Όμ†λ¥Ό λ¤ν”„ λ–  λ³΄λ©΄ λ‹¤μ μ‚¬μ§„κ³Ό κ°™μ΄ κ°κ° 40 λ°”μ΄νΈμ™€ 32 λ°”μ΄νΈκ°€ μ €μ¥λμ–΄ μλ‹¤. 
(μ΄ μ‚¬μ§„μ—μ„λ” λ‹¤ ν•©μ³μ„ 0x48 = 72 λ°”μ΄νΈλ¥Ό λΈ”λ΅ μ„ νƒν–λ‹¤)
![[Pasted image 20250813150412.png]]
### ragnar_locker.5920E0 ν•¨μ λ¶„μ„ (2λ² μν–‰, RC4 λ³µνΈν™”)
μ΄ ν•¨μλ” λ©”λ¨λ¦¬μ— μλ” κ°’ 1, 0x40, λ©”λ¨λ¦¬μ— μλ” κ°’ 2, 0x40μΌλ΅ 4κ°μ parameterλ¥Ό λ°›μ•„μ„ λ™μ‘ν•λ‹¤. 
μ΄ λ•, λ©”λ¨λ¦¬μ— μλ” κ°’μ€ λ¤ν”„λ¥Ό λ¨λ©΄ κ°κ° μ •ν™•ν•κ² 0x40 = 64 λ°”μ΄νΈκ°€ μλ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤. 
![[Pasted image 20250813152106.png]]
(λ‹¨, λΈ”λ΅ μ„¤μ •ν• λ©”λ¨λ¦¬μ κ°’μ€ μ¤‘κ°„μ μ΄λ΅μƒ‰ 0μ„ λΉΌκ³  λ΄μ•Ό ν•λ‹¤λ” κ²ƒμ„ μμ§€ λ§μ.....)

μ΄μ  ν•¨μ λ‚΄λ¶€λ΅ λ“¤μ–΄κ°€μ„ λ¶„μ„ν•΄ λ³΄μ. 
![[Pasted image 20250805193812.png]]
μ΄ ν•¨μμ—μ„λ” λ³„λ„μ ν•¨μ νΈμ¶ μ—†μ΄ ν•¨μ μ—ν•„λ΅κ·ΈκΉμ§€ λ°λ³µλ¬Έμ„ μ‚¬μ©ν•΄ νΉμ •ν• μ—°μ‚°μ„ μν–‰ν•κ³ , μ—°μ‚°μ΄ λλ‚λ©΄ ν•¨μ μ—ν•„λ΅κ·Έλ¥Ό ν†µν•΄ ν•¨μ λ°”κΉ¥μΌλ΅ λ‚κ°„λ‹¤. 
μ΄ λ• μ²μ λ°λ³µλ¬Έμ€ EAX λ μ§€μ¤ν„°μ κ°’μ΄ 256μ΄ λ  λ•κΉμ§€ μ‹¤ν–‰ν•κ³ , λ‘ λ²μ§Έ λ°λ³µλ¬Έμ€ ESI λ μ§€μ¤ν„°μ κ°’μ΄ 256μ΄ λ  λ•κΉμ§€ μ‹¤ν–‰ν•λ‹¤. 
λν•, κ·Έ λ°‘μ—λ„ λ°λ³µλ¬Έμ΄ μλ”λ°, μ„Έ λ²μ§Έ λ°λ³µλ¬Έμ€ `cmp` λ…λ Ήμ–΄κ°€ μ—†λ” κ²ƒμΌλ΅ λ³΄μ•„ `while`λ°λ³µλ¬Έμ„ μ‚¬μ©ν•λ” κ²ƒμΌλ΅ μ¶”μΈ΅λλ‹¤. μ‹¤ν–‰μ„ μ „λ¶€ λλ‚΄λ©΄ EAX λ μ§€μ¤ν„°κ°€ κ°€λ¦¬ν‚¤λ” λ©”λ¨λ¦¬ μ£Όμ†μ— μ•„λ μ‚¬μ§„μ²λΌ 64λ°”μ΄νΈ κ°’μ΄ μ €μ¥λμ–΄ μλ‹¤. 
![[Pasted image 20250805195857.png]]

λν•, ν•¨μ μ‹¤ν–‰ μ΄ν›„μ—λ” μΈμλ΅ λ°›μ€ λ‘ κ°μ 64 λ°”μ΄νΈ κ°’ μ¤‘ λ‘ λ²μ§Έ 64 λ°”μ΄νΈκ°€ μ•μ•„λ³΄κΈ° μ‰½κ² λ³€κ²½λμ—κΈ° λ•λ¬Έμ—, ν•΄λ‹Ή ν•¨μμ μ—­ν• μ€ μ΄ 64 λ°”μ΄νΈλ¥Ό λ³µνΈν™”ν•κ±°λ‚ μ•”νΈν™”ν™”ν•λ” κ²ƒμΌλ΅ μ¶”μΈ΅λλ‹¤. 
**Before**
![[Pasted image 20250813155946.png]] 
**After**
![[Pasted image 20250813155959.png]]

λ‘ λ²μ§Έλ΅ μ‹¤ν–‰ν•  λ•λ” μ²« λ²μ§Έ μ‹¤ν–‰ν–μ„ λ•μ μƒμ„ λ°”μ΄νΈ, 0x40, AAB260, 0x56μ„ parameterλ΅ κ°€μ§€λ©°, μ„Έ λ²μ§Έ parameterμ κ°’μ€ λ‹¤μκ³Ό κ°™λ‹¤. 
![[Pasted image 20250813162129.png]]
μ΄λ¥Ό μ‹¤ν–‰μ‹ν‚¤λ©΄, ν•¨μλ” μ²« λ²μ§Έλ΅ λ™μ‘ν•  λ•μ™€ λ™μΌν•κ² λ™μ‘ν•λ©°, ν•¨μ μ‹¤ν–‰ μ΄ν›„, μ„μ μ‚¬μ§„κ³Ό κ°™μ€ μ„μΉμ— μλ λ©”λ¨λ¦¬μ κ°’μ΄ μ‚¬λμ΄ μ•μ•„λ³Ό μ μλ„λ΅ λ³€ν•λ‹¤. 
λ”°λΌμ„, μ΄λ²μ—λ” ν™•μ‹¤ν•κ² ν•΄λ‹Ή ν•¨μμ μ—­ν• , Parameterλ¥Ό μ• μ μλ‹¤. 
1. μ—­ν• : κ³ μ •λ ν‚¤λ¥Ό κ°€μ§€κ³  μΈμλ΅ λ“¤μ–΄μ¤λ” λ°”μ΄νΈ λ°°μ—΄μ„ λ³µνΈν™”
2. Parameter
	1. λ³µνΈν™”μ— μ‚¬μ©ν•λ” κ³ μ •λ ν‚¤μ μ£Όμ†
	2. κ³ μ •λ ν‚¤μ λ°”μ΄νΈ κΈΈμ΄
	3. λ³µνΈν™” λ€μƒ λ°”μ΄νΈ λ°°μ—΄μ μ£Όμ†
	4. λ³µνΈν™” λ€μƒ λ°”μ΄νΈ λ°°μ—΄μ κΈΈμ΄
![[Pasted image 20250813163621.png]]
μ΄ ν‚¤μ›λ“μ κ³µν†µμ μ€ λ°±μ—…, λ³΄μ•, μ›κ²© κ΄€λ¦¬μ™€ κ΄€λ ¨λ μ„λΉ„μ¤λ΅, νμΌ μ•”νΈν™”λ‚ κ·Έ μ΄μ „μ— ν•΄λ‹Ή μ„λΉ„μ¤λ“¤μ„  μΆ…λ£ν•κΈ° μ„ν•΄ λ„£μ€ κ²ƒμΌλ΅ μ¶”μΈ΅λλ‹¤. 

---
## λ³Όλ¥¨ μ„€λ„ λ³µμ‚¬λ³Έ μ‚­μ 
κ·Έ λ’¤λ΅ [OpenSCManagerA](https://learn.microsoft.com/ko-kr/windows/win32/api/winsvc/nf-winsvc-openscmanagera)ν•¨μλ¥Ό μ‚¬μ©ν•΄ ν•΄λ‹Ή μ»΄ν“¨ν„°μ—μ„ [[μ„λΉ„μ¤ μ μ–΄ κ΄€λ¦¬μ]]μ— λ€ν• μ—°κ²°μ„ μ„¤μ •ν•κ³  ν•΄λ‹Ή μ„λΉ„μ¤ μ μ–΄ κ΄€λ¦¬μ λ°μ΄ν„° λ² μ΄μ¤λ¥Ό μ—°λ‹¤. 
μ΄ λ•, `0, 0, F003F`λ¥Ό μΈμλ΅ λ°›μ•„ μ‚¬μ©μ μ»΄ν“¨ν„°μ κΈ°λ³Έ μ„λΉ„μ¤ μ μ–΄ κ΄€λ¦¬μμ— λ€ν•΄ κ±°μ λ¨λ“  κ¶ν•μ„ κ°€μ§„ ν•Έλ“¤μ„ μ”μ²­ν•λ‹¤. ([κ³µμ‹ λ¬Έμ„](https://learn.microsoft.com/ko-kr/windows/win32/services/service-security-and-access-rights) μ°Έκ³ )
![[Pasted image 20250813171818.png]]
κ·Έ λ°‘μΌλ΅λ” [GetModuleFileNameW](https://learn.microsoft.com/ko-kr/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulefilenamew)ν•¨μλ΅ Ragnar Locker λμ„¬μ›¨μ–΄ νμΌ κ²½λ΅λ¥Ό EAX λ μ§€μ¤ν„°κ°€ κ°€λ¦¬ν‚¤λ” μ£Όμ†μ— μ €μ¥ν•λ©°,![[Pasted image 20250806134016.png]]
[PathFindFileNameW](https://learn.microsoft.com/ko-kr/windows/win32/api/shlwapi/nf-shlwapi-pathfindfilenamew)ν•¨μ, [GetWindowsDirectoryW](https://learn.microsoft.com/ko-kr/windows/win32/api/sysinfoapi/nf-sysinfoapi-getwindowsdirectoryw)ν•¨μλ¥Ό μ‚¬μ©ν•΄ ν„μ¬ μ‹¤ν–‰ μ¤‘μΈ μ»΄ν“¨ν„°μ `Windows`λ””λ ‰ν„°λ¦¬μ κ²½λ΅λ¥Ό λ¬Έμμ—΄ ν•νƒλ΅ λ°ν™ν•΄ μ•„λμ²λΌ EAX λ μ§€μ¤ν„°κ°€ κ°€λ¦¬ν‚¤λ” μ£Όμ†μ— μ €μ¥ν•λ‹¤. 
![[Pasted image 20250806134605.png]]
μ΄μƒμ ν•¨μλ“¤μ€ μ„λΉ„μ¤ μ μ–΄ κ΄€λ¦¬μλ¥Ό μ‚¬μ©ν•΄ μ΄μ „μ— λ³µνΈν™” ν•΄ λ’€λ λ°±μ—…, λ³΄μ• κ΄€λ¦¬ λ“±μ μ„λΉ„μ¤λ¥Ό μ¤‘μ§€ν•κ³ , νμΌ μ•”νΈν™” λ“±μ ν–‰μ„λ¥Ό ν•κΈ° μ„ν•΄ λ™μ‘ν• κ²ƒμΌλ΅ μ¶”μΈ΅λλ‹¤. 

μ΄ν›„ [QueryDosDeviceW](https://learn.microsoft.com/ko-kr/windows/win32/api/fileapi/nf-fileapi-querydosdevicew)ν•¨μλ¥Ό μ‚¬μ©ν•΄ `\\Device\\HarddiskVolume3`κ²½λ΅λ¥Ό μ–»μ–΄ μ™€μ„ μ €μ¥ν•λ©°, ν•΄λ‹Ή κ²½λ΅λ” Windows μ΄μμ²΄μ μ—μ„ μ‚¬μ©ν•λ” λ””λ°”μ΄μ¤ κ²½λ΅ μ¤‘ ν•λ‚λ΅, μ»¤λ„ μμ¤€μ—μ„ λ¬Όλ¦¬μ  λλ” λ…Όλ¦¬μ  λ””μ¤ν¬λ¥Ό μ‹λ³„ν•κΈ° μ„ν•΄ μ‚¬μ©ν•λ‹¤. 
![[Pasted image 20250806140851.png]]
ν•΄λ‹Ή κ²½λ΅λ” λ³Όλ¥¨ μ„€λ„ λ³µμ‚¬λ³Έμ„ μ‚­μ ν•λ” κ³Όμ •μ—μ„ λ‚νƒ€λ‚  μ μλ”λ°, κ·Έ μ΄μ λ” `C:\`λ“λΌμ΄λΈμ— λ€ν• μ„€λ„ λ³µμ‚¬λ³Έμ€ `\\Device\\HarddiskVolumeX`ν•νƒλ΅ λ‚΄λ¶€μ μΌλ΅ κ΄€λ¦¬λκΈ° λ•λ¬Έμ΄λ‹¤. 

κ·Έ λ’¤λ΅ `OpenProcess`, `TerminateProcess`, `CloseHandle` ν•¨μλ“¤κ³Ό λ°λ³µλ¬Έμ„ μ‚¬μ©ν•΄ ν„μ¬ μ‹¤ν–‰ μ¤‘μΈ ν”„λ΅μ„Έμ¤λ“¤μ„ κ°•μ λ΅ μΆ…λ£ν•λ‹¤.
![[Pasted image 20250806142351.png]]
μ„μ μ‚¬μ§„μ—μ„ ν•΄λ‹Ή λ°λ³µλ¬Έμ„ λ‡ λ² μ‹¤ν–‰ν•λ‹¤ λ‚μ¤‘μ—λ” νλ€μƒ‰ λ¶„κΈ° μ•μΌλ΅ λ“¤μ–΄κ°€λ”λ°, 
μ΄ λ• `\\Device\\HarddiskVolume3\\System32\\svchost32.exe`μ™€ `dllhost.exe`, `RuntimeBroker.exe`, `explorer.exe`, `shellhost.exe`λ“±μ μ‘μ© ν”„λ΅κ·Έλ¨κ³Ό ν”„λ΅κ·Έλ¨μ μ¤λƒ…μƒ· λ“±μ„ μνν•λ‹¤. 
π’΅μ΄ λ• μ£Όμν•  μ μ€ ν•΄λ‹Ή μ§€μ  κ·Όμ²μ— [[μ•ν‹° λ””λ²„κΉ…]]μ„ μν–‰ν•λ” λ¶€λ¶„μ΄ μμ–΄ κ·Έ λ°‘μ ν•¨μμΈ `ragnar_locker.591000`μΌλ΅ λ°”λ΅ λ„μ–΄κ° μ μλ„λ΅ κ·Έ κ³³μ— CPUκ°€ μ‹¤ν–‰ν•  λ…λ Ήμ–΄λ¥Ό κΈ°μ–µν•λ” EIP λ μ§€μ¤ν„°λ¥Ό μ„¤μ •ν•΄μ„ λ°”λ΅ λ„μ–΄κ°€μ•Ό ν•λ‹¤. 

`ragnar_locker.591000`μΌλ΅ EIPλ¥Ό μ„¤μ •ν•κ³  F7μΌλ΅ λ“¤μ–΄κ°€ λ¶„μ„ν•λ©΄ λ‹¤μκ³Ό κ°™μ€ μ‚¬μ§„μ΄ λ‚μ¨λ‹¤. 
![[Pasted image 20250806155640.png]]
μ΄ ν•¨μλ” [GetNativeSystemInfo](https://learn.microsoft.com/ko-kr/windows/win32/api/sysinfoapi/nf-sysinfoapi-getnativesysteminfo)ν•¨μμ™€ [LoadLibraryW](https://learn.microsoft.com/ko-kr/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibraryw), [GetProcAddress](https://learn.microsoft.com/ko-kr/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress), [GetStartupInfoW](https://learn.microsoft.com/ko-kr/windows/win32/api/processthreadsapi/nf-processthreadsapi-getstartupinfow), [CreateProcessW](https://learn.microsoft.com/ko-kr/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessw)ν•¨μλ¥Ό μ‚¬μ©ν•΄ μƒλ΅μ΄ ν”„λ΅μ„Έμ¤λ¥Ό μƒμ„±ν•κ³ , μ΄λ¥Ό μ„ν• DLLλ“¤μ„ λ™μ μΌλ΅ κ°€μ Έ μ¨λ‹¤. 
μ΄ λ•, Parameterλ΅ `kernel32.dll`κ³Ό `Wow64EnableWow64FsRedirection`μ„ λ°›μ•„ μ „μ²΄μ μΈ νμΌ μ‹μ¤ν…μ„ 64bitμ™€ 32bit μƒκ΄€μ—†μ΄ μΌλ°μ μΈ μƒνƒλ΅ μ ‘κ·Όν•  μ μλ„λ΅ ν•λ©°, Wmicκ³Ό Vssadminμ„ μ‚¬μ©ν•΄ μ„€λ„ λ³µμ‚¬λ³Έμ„ μ‚­μ ν•λ‹¤. 
![[Pasted image 20250814141950.png]]

## κ³µκ°ν‚¤ λ³µνΈν™”
μ΄ν›„ ν•¨μ ν”„λ΅¤λ΅κ·Έλ¥Ό ν†µν•΄ ν•¨μ λ°”κΉ¥μΈ entryλ΅ λ‚κ°€κ³  λ‚μ„ κ·Έ λ°‘μ ν•¨μμΈ `ragnar_locker.5920E0`μΌλ΅ λ“¤μ–΄κ°€λ©΄ μ„μ—μ„ λ¶„μ„ν–λ λ‚΄μ©λ€λ΅ λ³µνΈν™”λ¥Ό μν–‰ν•λ‹¤. 
μ΄ ν•¨μμ—μ„λ” μ΄μ „μ— λ³µνΈν™”ν–λ 64 byte λ°°μ—΄μ λ°”λ΅ λ°‘μ΄ μλ” 0x1C3 byteμ§λ¦¬ λ°”μ΄νΈ λ°°μ—΄μ„ μ‹¤ν–‰ νμΌ λ‚΄μ— μλ” 64 byteμ ν‚¤λ΅ λ³µνΈν™”ν•λ‹¤. λ³µνΈν™” κ²°κ³Όλ” λ‹¤μ μ‚¬μ§„κ³Ό κ°™λ‹¤. 
![[Pasted image 20250814050208.png]]
λ”°λΌμ„, ν•΄λ‹Ή μ½”λ“λ” RSA μ•”νΈν™” λ“±μ— μ‚¬μ©ν•λ” κ³µκ°ν‚¤λ¥Ό λ³µνΈν™”ν•λ” μ½”λ“λ΅ μ¶”μΈ΅λλ‹¤. 
λν•, μ•”νΈλ¬Έκ³Ό ν‰λ¬Έμ λ°”μ΄νΈ κΈΈμ΄κ°€ λ™μΌν•κΈ° λ•λ¬Έμ— λ³µνΈν™”μ— μ‚¬μ©λ μ•”νΈ μ•κ³ λ¦¬μ¦μ€ μ¤νΈλ¦Ό μ•”νΈλ‚ λΈ”λ΅ μ•”νΈμ ECB, CTR, OFB, CFB λ“± μ¤νΈλ¦Ό μ•”νΈμ™€ λΉ„μ·ν• μ•κ³ λ¦¬μ¦μ„ μ‚¬μ©ν–μ„ κ²ƒμΌλ΅ μ¶”μΈ΅ν•  μ μμ—λ‹¤. 

λν•, κ·Έ λ°‘μ—λ„ 0x7D4 byte λ°°μ—΄μ„ λ³µνΈν™”ν•λ” μ½”λ“κ°€ μλ”λ°, ν•΄λ‹Ή μ½”λ“λ¥Ό μ‹¤ν–‰ν•λ©΄ parameterλ΅ λ°›μ€ λ°”μ΄νΈ λ°°μ—΄μ΄ λμ„¬λ…ΈνΈλ¥Ό λ‚νƒ€λ‚΄λ” λ°”μ΄νΈ λ°°μ—΄λ΅ λ³µνΈν™”λλ‹¤. 

μ΄ν›„ `ragnar_locker.591F90`ν•¨μλ΅ λ“¤μ–΄κ°€ λ³΄λ©΄ [CryptAcquireContextW](https://learn.microsoft.com/ko-kr/windows/win32/api/wincrypt/nf-wincrypt-cryptacquirecontextw) ν•¨μμ™€ [CryptDestroyKey](https://learn.microsoft.com/ko-kr/windows/win32/api/wincrypt/nf-wincrypt-cryptdestroykey)ν•¨μλ¥Ό μ‚¬μ©ν•λ©°, μ΄ν›„ κ³µκ°ν‚¤ μ•”νΈμ— μ‚¬μ©λλ” ν•¨μμΈ [CryptImportPublicKeyInfo](https://learn.microsoft.com/ko-kr/windows/win32/api/wincrypt/nf-wincrypt-cryptimportpublickeyinfo)ν•¨μλ¥Ό μ‚¬μ©ν•΄ κ³µκ°ν‚¤μ μ •λ³΄λ¥Ό λ³€ν™ν•κ³  κ³µκ°ν‚¤μ ν•Έλ“¤μ„ λ°ν™ν•λ‹¤. 
λ”°λΌμ„, ν•΄λ‹Ή ν•¨μμ μ—­ν• μ€ μ•„λ μ‚¬μ§„μ²λΌ μ•”νΈν™”λ¥Ό μ„ν•΄ κ³µκ°ν‚¤λ¥Ό λ‹¤λ¥Έ ν•¨μμ— μ „λ‹¬ν•λ‹¤. 
![[Pasted image 20250814060243.png]]

## λμ„¬λ…ΈνΈ μ μ‘
κ·Έλ° λ’¤ `GetComputerNameW`ν•¨μλ΅ μ‹¤ν–‰ μ»΄ν“¨ν„°μ μ΄λ¦„μ„ λ°›μ•„ μ¤κ³  `ragnar_locker.592240`ν•¨μλ¥Ό μ‹¤ν–‰ν•κ³  ν•΄λ‹Ή ν•¨μκ°€ λλ‚λ©΄ `lstcpyW`μ™€ `lstcatW`ν•¨μλ¥Ό μ‹¤ν–‰ν•΄ λμ„¬λ…ΈνΈμ μ΄λ¦„μ²λΌ λ³΄μ΄λ” `RGNR_818CD995.txt`λ¥Ό μ§€μ •ν•κ³ , [CryptBinaryToStringA](https://learn.microsoft.com/ko-kr/windows/win32/api/wincrypt/nf-wincrypt-cryptbinarytostringa)ν•¨μλ΅ λ°”μ΄νΈ λ°°μ—΄μ„ ν•μ‹μ΄ μ§€μ •λ λ¬Έμμ—΄λ΅ λ³€ν•ν•λ‹¤. μ΄ λ•μ λ°”μ΄νΈ λ°°μ—΄μ€ λμ„¬λ…ΈνΈμ λ‚΄μ©μ— ν•΄λ‹Ήν•λ‹¤.
κ·Έ λ‹¤μ `CreateFileW`ν•¨μλ¥Ό μ΄μ©ν•΄ μ§€μ •λ λμ„¬λ…ΈνΈμ μ΄λ¦„μΌλ΅ λμ„¬λ…ΈνΈ νμΌμ„ λ§λ“¤κ³ , λμ„¬λ…ΈνΈμ— λ“¤μ–΄κ° λ‚΄μ©λ“¤μ„ κΈ°λ΅ν•λ‹¤. ![[Pasted image 20250806171218.png]]
μ΄ λ• λμ„¬λ…ΈνΈκ°€ μƒμ„±λλ” κ²½λ΅λ” `C:\\Users\\Public\\Documents\\RGNR_[ν•΄μ‹κ°’].txt`μ΄λ©°, ν•΄λ‹Ή κ²½λ΅μ— λ“¤μ–΄κ°€ λ³΄λ©΄ μ‹¤μ λ΅ λμ„¬λ…ΈνΈκ°€ μ΅΄μ¬ν•λ‹¤. 
λν•, λμ„¬λ…ΈνΈμ—μ„ 'RAGNAR SECRET'μ΄λΌλ” λ¶€λ¶„μ΄ μλ”λ°, μ΄λ” μ•„λμ μ΄λ―Έμ§€μ— λ‚μ¤λ” λ°”μ΄νΈλ“¤μ„ Base64λ΅ μΈμ½”λ”©ν• κ°’μ΄λ‹¤. 
![[Pasted image 20250813155959.png]]

## νμΌ νƒμƒ‰ λ° μ•”νΈν™” μν–‰
λμ„¬λ…ΈνΈκΉμ§€ λ§λ“¤κ³  λ‚μ„ `ragnar_locker.591950`ν•¨μλ΅ λ“¤μ–΄κ°€ λ³΄λ©΄ λ‹¤μκ³Ό κ°™μ€ μ‚¬μ§„μ΄ λ‚μ¨λ‹¤. 
![[Pasted image 20250806171609.png]]
[FindFirstFileW](https://learn.microsoft.com/ko-kr/windows/win32/api/fileapi/nf-fileapi-findfirstfilew)ν•¨μμ™€ [GetFullPathNameW](https://learn.microsoft.com/ko-kr/windows/win32/api/fileapi/nf-fileapi-getfullpathnamew)ν•¨μκ°€ μ‚¬μ§„ μ†μ—μ„ κ°™μ΄ μ‚¬μ©λ κ²ƒμΌλ΅ λ³΄μ•„ ν•΄λ‹Ή ν•¨μλ” λ°λ³µλ¬Έμ„ λλ¦¬λ©΄μ„ [FindNextFileW](https://learn.microsoft.com/ko-kr/windows/win32/api/fileapi/nf-fileapi-findnextfilew)λ“±μ ν•¨μμ™€ κ°™μ΄ μ‚¬μ©ν•΄ λ””λ ‰ν„°λ¦¬ λ‚΄μ λ¨λ“  νμΌμ΄λ‚ ν΄λ”λ¥Ό λ°λ³µμ μΌλ΅ κ²€μƒ‰ν•μ—¬ μ•”νΈν™”ν•  νμΌμ„ μ°Ύλ” ν•¨μλ΅ μ μ¶”ν•  μ μλ‹¤. 
μ΄μ— λ€ν•΄ μ‹¤ν–‰μ„ ν•λ©΄μ„ λ” μμ„Έν•κ² λ¶„μ„ν•΄ λ³΄μ.

λ¨Όμ € `FindFirstFileW`ν•¨μλ΅ μµμƒμ„ ν΄λ”μΈ `C:\`ν΄λ”μ νμΌλ“¤λ¶€ν„° μ°¨λ΅€λ€λ΅ κ²€μƒ‰ν•λ©°, λ€μ†λ¬Έμ κ°€λ¦¬μ§€ μ•κ³  λ¬Έμμ—΄μ„ λΉ„κµν•λ” `lstrcmpiW`ν•¨μλ΅ λ―Έλ¦¬ μ„¤μ •ν•΄ λ‘” λ¬Έμμ—΄, μ¦‰ λ―Έλ¦¬ μ„¤μ •ν•΄ λ‘” νμΌμ΄λ‚ ν΄λ” λ…μ„ μ°Ύμ•„ λΉ„κµν•κ³ , ν•΄λ‹Ή νμΌμ μ΄λ¦„μ€ `GetFullPathNameW`ν•¨μλ΅ μ°Ύμ•„ λΉ„κµν•λ‹¤.
λν•, νμΌμ ν™•μ¥μλ¥Ό νƒμƒ‰ν•λ” `PathFindExtensionW`ν•¨μλ΅ λ¨λ“  νμΌμ— λ€ν•μ—¬ λ―Έλ¦¬ μ„¤μ •ν•΄ λ‘” ν™•μ¥μλ¥Ό μ°Ύμ•„ λΉ„κµν•λ‹¤. 
λ―Έλ¦¬ μ„¤μ •ν•΄ λ‘” νμΌ, ν™•μ¥μ, ν΄λ” μ΄λ¦„μ€ λ‹¤μκ³Ό κ°™λ‹¤. 
1. νμΌ μ΄λ¦„: λμ„¬λ…ΈνΈ (`RGNR_818CD995.txt`), `autorun.inf`,`boot.ini`, `bootfont.bin`, `bootsect.bak`, `desktop.ini`, `iconcache.db`, `ntldr`, `ntuser.dat`, `ntuser.dat.log`, `ntuser.ini`, `thumbs.db`
2. ν™•μ¥μ: `db`, `sys`, `dll`, `lnk`, `msi`, `drv`, `exe`
3. ν΄λ” μ΄λ¦„: `Windows`, `Windows.old`, `Tor browser`, `Internet Explorer`, `Google`, `Opera`, `Opera Software`, `Mozilla`, `Mozilla Firefox`, `$Recycle.Bin`, `ProgramData`, `All Users`

μ΄ κ²½μ°, λμ„¬μ›¨μ–΄μ— κ±Έλ¦° μ‚¬μ©μλ” λμ„¬λ…ΈνΈκ°€ μ•”νΈν™”λμ§€ μ•κ³  λ³΄μ—¬μ•Ό ν•λ©°, κ·Έ μ™Έμ μ΄λ¦„λ“¤μ€ μ‹μ¤ν… λ™μ‘μ— ν•„μ”ν• κ²ƒλ“¤μ΄κΈ° λ•λ¬Έμ— ν•΄λ‹Ή μ΄λ¦„λ“¤μ€ λμ„¬μ›¨μ–΄ μ‹¤ν–‰ μ‹ μ•”νΈν™”μ—μ„ μ μ™Έν•λ” νμΌ, λ””λ ‰ν„°λ¦¬ μ΄λ¦„, ν™•μ¥μλ΅ μ μ¶”ν•  μ μλ‹¤.
>[!example]- μμ‹ μ΄λ―Έμ§€
>![[Pasted image 20250807135225.png]] ![[Pasted image 20250807141736.png]] ![[Pasted image 20250807141841.png]]

μ΄ λ• λ°λ³µλ¬Έμ„ λλ©΄μ„ μµμƒμ„ λ””λ ‰ν„°λ¦¬λ¶€ν„° κ·Έ λ°‘μ λ””λ ‰ν„°λ¦¬λ¥Ό ν•λ‚μ”© κ²€μƒ‰ν•μ—¬ (μ: `C:\inetpub`, `C:\PerfLogs` μμ„λ΅) μ•”νΈν™”μ—μ„ μ μ™Έν•  ν•­λ©λ“¤μ„ κ²€μƒ‰ν•λ‹¤. 
![[Pasted image 20250807135520.png]]
λν• λ°λ³µλ¬Έμ„ λλ©° κ²€μ‚¬ν•λ” λ™μ‹μ— μ¬κ·€ν•¨μλ΅ `ragnar_locker.591950`ν•¨μ μκΈ° μμ‹ μ„ κ³„μ† μ‹¤ν–‰ν•μ—¬ `FindNextFileW`ν•¨μμ™€ ν•¨κ» μ‚¬μ©ν•΄ νμΌμ„ κ³„μ† νƒμƒ‰ν•λ©°, κ·Έμ™€ λ™μ‹μ— νμΌ μ•”νΈν™”λ¥Ό μν–‰ν•λ‹¤.
νμΌ μ•”νΈν™”λ¥Ό μν–‰ν•λ” ν•¨μμ— λ€ν•΄μ„λ” [[Ragnar Locker μ•”νΈν™”μ™€ λ³µνΈν™” μ•κ³ λ¦¬μ¦ νμ•…]]μ—μ„ λ³Ό κ²ƒμ΄λ‹¤.

μ­‰ μ‹¤ν–‰ν•λ‹¤ λ³΄λ©΄ `ragnar_locker.591950`ν•¨μκ°€ νΈμ¶ν•λ”`ragnar_locker.591490`ν•¨μλ΅ λ“¤μ–΄μ¨λ‹¤.![[Pasted image 20250807142435.png]]
μ΄ ν•¨μμ—μ„λ” `CreateFileW`ν•¨μλ΅ λ””λ ‰ν„°λ¦¬ λ‚΄μ νμΌμ„ μ „λ¶€ μνν•λ©° ν•΄λ‹Ή λ””λ ‰ν„°λ¦¬μ™€ κ·Έ μ•μ ν•μ„ λ””λ ‰ν„°λ¦¬μ— λμ„¬λ…ΈνΈλ¥Ό λ§λ“¤κ³  νμΌ μ•”νΈν™”λ¥Ό μν–‰ν•λ©°, λμ„¬λ…ΈνΈλ¥Ό λ§λ“λ” μ΅°κ±΄μ€ ν•΄λ‹Ή λ””λ ‰ν„°λ¦¬ λ‚΄μ ν•μ„ λ””λ ‰ν„°λ¦¬λ¥Ό μ „λ¶€ μνν•μ—¬ μ•”νΈν™”λ¥Ό μ™„λ£ν–μ„ λ•λ΅ μ¶”μΈ΅λλ‹¤. 
![[Pasted image 20250807150209.png]]

## μ•…μ„± ν–‰μ„κ°€ λλ‚ μ΄ν›„
μ•”νΈν™”κ°€ μ „λ¶€ λλ‚κ³  λ‚λ©΄, λ©”λ¨μ¥μ„ μ‹¤ν–‰ν•΄ λμ„¬λ…ΈνΈλ¥Ό λ¨λ‹ν„°μ— μ¶λ ¥ν•λ©°, [ExitProcess](https://learn.microsoft.com/ko-kr/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess)ν•¨μλ¥Ό μ‚¬μ©ν•΄ λ¨λ“  ν”„λ΅μ„Έμ¤μ™€ νΈμ¶ν• ν”„λ΅μ„Έμ¤λ¥Ό μ „λ¶€ μΆ…λ£ν•κ³  μκΈ° μμ‹  λν• μΆ…λ£ν•λ‹¤. 
μ΄ λ• `notepad.exe`λ¥Ό μ‹¤ν–‰ν•λ”λ°, ν„μ¬ ν”„λ΅μ„Έμ¤ ν† ν° ν•Έλ“¤μ„ κ°€μ Έμ¤κ³ , ν† ν°μ„ λ³µμ ν•΄ κ¶ν•μ„ μƒμΉμ‹ν‚¤λ©°, μƒμΉλ ν† ν°κ³Ό ν•¨κ» `CreateProcessW` ν•¨μλ¥Ό μ‚¬μ©ν•΄ ν”„λ΅μ„Έμ¤λ¥Ό μƒμ„±ν•λ‹¤. 
![[Pasted image 20250814090245.png]]
![[Pasted image 20250814090300.png]]

---
## λ” μμ„Έν•κ³  μ¶”κ°€μ μΈ λ¶„μ„
[[Ragnar Locker μ•”νΈν™”μ™€ λ³µνΈν™” μ•κ³ λ¦¬μ¦ νμ•…]]
[[Ragnar Locker λμ„¬μ›¨μ–΄ λ³µνΈν™”]]