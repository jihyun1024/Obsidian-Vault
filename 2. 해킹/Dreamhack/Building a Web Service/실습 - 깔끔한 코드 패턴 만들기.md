## 들어가며
---
이번 강의에서는 저번에 구현했던 [[실습 - 로그인 기능 구현하기]] 강의의 코드를 재구성해서 더 직관적이고 확장 가능한 코드로 개선하는 방법을 실습한다. 

구현된 웹 사이트는 핵심 기능들이 이미 잘 작동하지만, 기능들끼리 연결성이 부족해서 사용하기 불편하고 확장성이 떨어진다는 한계가 있다. 예를 들어 사용자가 회원가입, 로그인, 로그아웃 기능을 한 번에 사용하려면 **각각의 경로를 URL로 직접 입력해야만** 접근할 수 있다. 또한, **HTML 코드가 중복으로 사용**되거나 데이터베이스 관련 코드가 *app.py*라는 웹 서버 코드에 몰려 있어 **유지보수가 어려운 구조**를 띈다.

기능이 동일한 웹 사이트라 하더라도, 잘 작성된 코드는 읽기 쉽고 수정과 확장이 용이하며, 버그를 찾고 해결하는 시간을 줄여 생산성을 높일 수 있다.

이번 강의에서는 HTML 템플릿 상속을 활용해 중복된 코드를 제거하고, 데이터베이스 코드를 모듈화하여 관리의 효율성을 높이는 방법을 다루도록 한다. 또한 메인 페이지(`/`)를 생성해서 사용자들이 더 직관적으로 웹 사이트를 사용하도록 한다. 


## 웹 서버 코드
---
먼저, 개선할 웹 서버 코드의 디렉터리 트리 구조는 다음과 같다. 아래의 구조에 맞게 직접 프로그래밍을 하거나, [이 링크](https://dreamhack-lecture.s3.ap-northeast-2.amazonaws.com/uploads/web-service/flask-app-login-register.zip)를 통해 압축 파일을 다운로드해서 실습해도 좋다. 

```
.
├── app.py
└── templates
    ├── login_failure.html
    ├── login.html
    ├── login_success.html
    ├── register_failure.html
    ├── register.html
    └── register_success.html
```

각 파일의 내용은 [[실습 - 로그인 기능 구현하기]]에서 구현된 것을 참고하자. 


## 웹 사이트 재구성
---
**현재 구현된 웹 사이트의 문제점**
현재 구현된 웹 사이트는 회원가입, 로그인, 로그아웃과 같은 <u>핵심 기능들 간에 연결성이 부족해 개별로 작동</u>한다. 즉, 사용자가 회원가입 페이지를 사용하려면 `/register` 페이지를, 로그인 페이지를 사용하려면 `/login` 페이지를, 로그아웃 페이지를 사용하려면 `/logout` 페이지를 따로따로 URL 바에 직접 입력해서 번거롭게 접근해야 한다는 의미이다. 

**해결 방법**
이를 해결하기 위해서는 각 주요 기능들을 보다 더 자연스럽게 이용할 수 있도록 통합해 줘야 한다. 페이지마다 다른 기능을 이용할 수 있는 페이지로 이동할 수 있는 버튼을 만들기 위해서는 먼저 메인 페이지인 `/` 경로를 만들고, 해당 경로를 중심으로 재구성해야 한다. 

**웹 페이지 구상**
- 메인 페이지를 반환하는 `GET /` 엔드포인트를 새로 만들 것이다. 메인 페이지(*index.html*)에서는 로그인된 사용자의 `username`을 출력하고, 로그아웃 버튼을 보여 준다. 
- 로그인이 안 된 상태로 메인 페이지에 접근하면, 로그인 페이지로 리다이렉트시킨다. 
- 로그인에 성공할 경우, 기존의 `/login_success` 대신 메인 페이지로 리다이렉트시킨다.
- 로그인이나 회원가입에 실패할 경우, 되돌아갈 수 있는 버튼을 만든다. 
- 회원가입 성공할 경우, 기존의 `/register_success` 대신 로그인 페이지로 리다이렉트시킨다.


### 웹 사이트 재구성하기
---
재구성을 진행하면서, 각각의 파일별로 변경된 사항만 천천히 짚어보자. 

***index.html***
새로 추가된 메인 페이지로, 코드를 자세히 살펴보면 7번 라인에서 `username`을 `<h1>` 태그를 씌워 출력하며 8 ~ 10번 라인에서 `/logout` 경로로 이동해 로그아웃을 할 수 있는 버튼도 있다. 

```html
<!DOCTYPE html>
<html>
	<head>
		<title>Simple Flask Website</title>
	</head>
	<body>
		<h1>Hello, {{ username }}!</h1>
		<form action="/logout">
			<button>Log Out</button>
		</form>
	</body>
</html>
```

***login_failure.html***
로그인 실패 시 볼 수 있는 페이지로, 제목이 변경되었으며, 로그인 페이지인 `/login` 경로로 다시 갈 수 있는 버튼이 생겼다.

```html
<!DOCTYPE html>
<html>
	<head>
		<title>Simple Flask Website</title>
	</head>
	<body>
		<h2>Login Failed</h2>
		<form action="/login">
			<button>Go to Log in</button>
		</form>
	</body>
</html>
```

***login.html***
로그인 페이지로, 제목이 변경되었으며, 회원가입 페이지인 `/register` 경로로 이동할 수 있다.
```html
<!DOCTYPE html>
<html>
	<head>
		<title>Simple Flask Website</title>
	</head>
	<body>
		<h2>Login</h2>
		<form action="/login" method="post">
			Username:<br>
			<input type="text" id="username" name="username">
			<br><br>
			Password:<br>
			<input type="password" id="password" name="password">
			<br><br>
			<button>Login</button>
		</form>
		<br>
		<form action="/register">
			<button>Go to Register</button>
		</form>
	</body>
</html>
```

***login_success.html***
로그인 성공 페이지에 해당하며, 로그인에 성공하면 해당 페이지가 아닌 메인 페이지로 돌아가기 때문에 불필요해서 삭제하였다. 

***register_failure.html***
회원가입 실패 페이지에 해당하며, 제목이 변경되었고, 회원가입 페이지인 `/register` 경로로 다시 돌아갈 수 있는 버튼이 생겼다. 

```html
<!DOCTYPE html>
<html>
	<head>
		<title>Simple Flask Website</title>
	</head>
	<body>
		<h2>Registration Failed</h2>
		<form action="/register">
			<button>Go to Register</button>
		</form>
	</body>
</html>
```

***register.html***
회원가입 페이지에 해당하며, 제목이 변경되었고, 로그인 페이지인 `/login` 경로로 갈 수 있는 버튼이 생겼다. 

```html
<!DOCTYPE html>
<html>
	<head>
		<title>Simple Flask Website</title>
	</head>
	<body>
		<h2>Register</h2>
		<form action="/register" method="post">
			Username:<br>
			<input type="text" id="username" name="username">
			<br><br>
			Password:<br>
			<input type="password" id="password" name="password">
			<br><br>
			<button>Register</button>
		</form>
		<br>
		<form action="/login">
			<button>Go to Log in</button>
		</form>
	</body>
</html>
```

***register_success.html***
회원가입 성공 페이지에 해당하며, 회원가입에 성공하면 해당 페이지가 아닌 로그인 페이지로 리다이렉트되기 때문에 불필요해서 삭제하였다.

***app.py***
전체 코드는 다음과 같다. 

```python
from flask import Flask, render_template, redirect, request, url_for, session
import os
import sqlite3


app = Flask(__name__)
app.secret_key = os.urandom(32)


def init_db():
	conn = sqlite3.connect('accounts.db')
	cursor = conn.cursor()
	cursor.execute('''
		CREATE TABLE IF NOT EXISTS accounts (
			id        INTEGER PRIMARY KEY AUTOINCREMENT,
			username  TEXT UNIQUE NOT NULL,
			password  TEXT NOT NULL
		)
	''')
	conn.commit()
	conn.close()


def add_account(username, password):
	conn = sqlite3.connect('accounts.db')
	cursor = conn.cursor()
	try:
		cursor.execute('INSERT INTO accounts (username, password) VALUES (?, ?)', (username, password))
		conn.commit()
		conn.close()
		return True
	except sqlite3.IntegrityError:
		conn.close()
		return False


def check_account(username, password):
	conn = sqlite3.connect('accounts.db')
	cursor = conn.cursor()
	cursor.execute('SELECT * FROM accounts WHERE username = ? AND password = ?', (username, password))
	user = cursor.fetchone()
	conn.close()
	return user


@app.route('/', methods=["GET"])
def get_index():
	if 'username' not in session:
		return redirect(url_for('get_login'))
	return render_template('index.html', username=session['username'])


@app.route('/register', methods=['GET'])
def get_register():
	if 'username' in session:
		return redirect(url_for('get_index'))
	return render_template('register.html')


@app.route('/register', methods=['POST'])
def post_register():
	if 'username' in session:
		return redirect(url_for('get_index'))
	username = request.form.get('username')
	password = request.form.get('password')
	if add_account(username, password):
		return redirect(url_for('get_login'))
	else:
		return render_template('register_failure.html')


@app.route('/login', methods=['GET'])
def get_login():
	if 'username' in session:
		return redirect(url_for('get_index'))
	return render_template('login.html')


@app.route('/login', methods=['POST'])
def post_login():
	if 'username' in session:
		return redirect(url_for('get_index'))
	username = request.form.get('username')
	password = request.form.get('password')
	if check_account(username, password):
		session['username'] = username
		return redirect(url_for('get_index'))
	else:
		return render_template('login_failure.html')


@app.route('/logout', methods=['GET'])
def get_logout():
	session.clear()
	return redirect(url_for('get_login'))


if __name__ == '__main__':
	init_db()
	app.run(host='0.0.0.0', port=31337)
```

최종적으로 수정된 코드들은 [이 다운로드 링크](https://dreamhack-lecture.s3.ap-northeast-2.amazonaws.com/uploads/web-service/flask-app-login-final.zip)에 있으니, 만약 코딩하다 막히거나 하면 이 압축 파일을 열어서 설정하고 테스트해보자. 

### 재구성된 웹 사이트 테스트하기
---
이제 앞에서 재구성한 웹 서버를 한 번 테스트해보자. 

1. 터미널을 켜고, 앞서 구성한 디렉터리 구조에서 *app.py*가 위치한 최상위 디렉터리로 이동한 후 웹 서버를 실행하면 아래 사진에서 빨간 네모로 표시된 것처럼 출력되어야 한다. 
	![[Pasted image 20260115180259.png]]
2. 브라우저의 URL 바에 `http://127.0.0.1:31337/`을 입력한 후 이동하면 아래 사진과 같이 로그인 페이지가 나온다. 이는 사실 메인 페이지에 해당하는 `/` 경로로 접근했지만 사용자가 로그인이 되어 있지 않아 로그인 페이지인 `/login` 경로로 리다이렉트된 모습이다. 
	![[Pasted image 20260115180408.png]]
3. `Go to Register` 버튼을 눌러 회원가입 페이지로 이동하면 아래 사진과 같이 회원가입 페이지가 나오며, 가장 아래에 로그인 페이지로 이동할 수 있는 `Go to Log in` 버튼이 생겼다. 
	![[Pasted image 20260115180423.png]]
4. 회원가입 페이지에서 `username`에 `admin`을, `password`에 `qwe123`을 입력한 후 `Register` 버튼을 누르면 다음 사진과 같이 사용자가 로그인을 바로 진행할 수 있도록 <u>로그인 페이지로 리다이렉트</u>된 것을 확인할 수 있다.
	![[Pasted image 20260115180604.png]]
5. 로그인 페이지에서 일부러 로그인에 실패하게 되면 아래 사진처럼 로그인 실패 페이지가 나오며, 그 밑에는 다시 로그인 페이지로 돌아갈 수 있는 버튼이 생겼다. 
	![[Pasted image 20260115180655.png]]
6. 다시 로그인 페이지로 돌아와서, 이번에는 제대로 `admin`/`qwe123` 계정으로 로그인해서 로그인에 성공하면 다음 사진처럼 메인 페이지에 해당하는 `/` 경로로 이동한다. 
	![[Pasted image 20260115180855.png]]
7. 메인 페이지는 로그인된 사용자의 Username을 `Hello, Username!` 형태로 출력하며, 로그아웃할 수 있는 `Log Out` 버튼도 존재한다.


## 코드 깔끔하게 만들기
---
이제, 지금까지 만든 웹 사이트의 코드를 깔끔하게 만들어보자. 방금 만들었던 페이지는 당장은 잘 동작하나, 앞으로 이 강의에서 진행할 게시판 기능이나 기타 다른 기능을 추가로 구현하기 시작하면 코드의 크기가 커지면서 유지보수가 어려워질 것이다. 


### HTML에서 중복으로 사용하는 코드 제거
---
가장 먼저 이 웹 사이트의 HTML 코드들끼리 중복되는 코드가 많기 때문에, **Flask 템플릿 렌더링의 상속 구문을 사용해서 중복되는 코드를 제거할 것이다**.

먼저, 기존 웹 서버의 *templates* 디렉터리에 *base.html* 파일을 추가하고, 다음 내용을 작성한다. 

```html
<!DOCTYPE html>
<html>
	<head>
		<title>Simple Flask Website</title>
	</head>
	<body>
		{% block content %}{% endblock %}
	</body>
</html>
```

이 파일은 다른 모든 HTML 파일의 부모 역할을 하는 파일로, 다른 HTML 문서가 *base.html*의 
```html
{% block content %}{% endblock %}
```

부분에 각자의 내용을 채우는 방식으로 최종 HTML 문서가 생성된다. 

따라서, 다른 자식 템플릿 HTML 문서들은 다음과 같이 재작성할 수 있다. 설명은 [[Background - Flask]] 문서를 참고하고, 여기에는 결과물만 써 놓을 것이다. 

***index.html***
```html
{% extends 'base.html' %}

{% block content %}
  <h1>Hello, {{ username }}!</h1>
  <form action='/logout'>
    <button >Log Out</button>
  </form>
{% endblock %}
```

***login_failure.html***
```html
{% extends 'base.html' %}

{% block content %}
  <h2>Login Failed</h2>
  <form action='/login'>
    <button >Go to Log in</button>
  </form>
{% endblock %}
```

***login.html***
```html
{% extends 'base.html' %}

{% block content %}
  <h2>Login</h2>
  <form action='/login' method='post'>
    Username:<br>
    <input type='text' id='username' name='username'>
    <br><br>
    Password:<br>
    <input type='password' id='password' name='password'>
    <br><br>
    <button>Login</button>
  </form>
  <br>
  <form action='/register'>
    <button>Go to Register</button>
  </form>
{% endblock %}
```

***register_failure.html***
```html
{% extends 'base.html' %}

{% block content %}
  <h2>Registration Failed</h2>
  <form action='/register'>
    <button >Go to Register</button>
  </form>
{% endblock %}
```

***register.html***
```html
{% extends 'base.html' %}
  
{% block content %}
  <h2>Register</h2>
  <form action='/register' method='post'>
    Username:<br>
    <input type='text' id='username' name='username'>
    <br><br>
    Password:<br>
    <input type='password' id='password' name='password'>
    <br><br>
    <button>Register</button>
  </form>
  <br>
  <form action='/login'>
    <button>Go to Log in</button>
  </form>
{% endblock %}
```


### 데이터베이스 사용과 관련한 코드 분리
---
웹 사이트의 기능이 보다 다양해지면 데이터베이스에 저장되는 정보도 단순한 계정 정보뿐만 아니라 게시글, 시스템 로그, 거래 기록, 게임 순위표, 물건 재고 등으로 확대된다. 이때 데이터베이스에 저장할 데이터의 종류가 많아지면 데이터베이스와 관련한 코드를 모두 *app.py*에 몰아서 작성하게 될 경우 소스 코드가 방대해져 유지보수가 어려워지게 된다. 

이를 해결하기 위해 이번에는 데이터베이스 관련 코드를 *app.py*에서 분리해 별도의 *db.py* 파일로 관리하는 방법을 다뤄본다. 이후 *app.py*에서는 *db.py* 파일을 불러와 사용한다.

각각의 수정된 코드는 다음과 같다. 

***app.py***
아래는 *app.py*의 변경 사항이다. 

```python
from flask import Flask, render_template, redirect, request, url_for, session
import os
from db import init_db, check_account, add_account

app = Flask(__name__)
app.secret_key = os.urandom(32)


@app.route('/', methods=["GET"])
def get_index():
	if 'username' not in session:
		return redirect(url_for('get_login'))
	return render_template('index.html', username=session['username'])


@app.route('/register', methods=['GET'])
def get_register():
	if 'username' in session:
		return redirect(url_for('get_index'))
	return render_template('register.html')


@app.route('/register', methods=['POST'])
def post_register():
	if 'username' in session:
		return redirect(url_for('get_index'))
	username = request.form.get('username')
	password = request.form.get('password')
	if add_account(username, password):
		return redirect(url_for('get_login'))
	else:
		return render_template('register_failure.html')


@app.route('/login', methods=['GET'])
def get_login():
	if 'username' in session:
		return redirect(url_for('get_index'))
	return render_template('login.html')


@app.route('/login', methods=['POST'])
def post_login():
	if 'username' in session:
		return redirect(url_for('get_index'))
	username = request.form.get('username')
	password = request.form.get('password')
	if check_account(username, password):
		session['username'] = username
		return redirect(url_for('get_index'))
	else:
		return render_template('login_failure.html')


@app.route('/logout', methods=['GET'])
def get_logout():
	session.clear()
	return redirect(url_for('get_login'))


if __name__ == '__main__':
	init_db()
	app.run(host='0.0.0.0', port=31337)
```

***db.py***
아래는 새로 추가된 *db.py*의 전체 코드이다. 

```python
import sqlite3

def init_db():
    conn = sqlite3.connect('accounts.db')
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS accounts (
            id          INTEGER PRIMARY KEY AUTOINCREMENT,
            username    TEXT UNIQUE NOT NULL,
            password    TEXT NOT NULL
        )
    ''')
    conn.commit()
    conn.close()


def add_account(username, password):
    conn = sqlite3.connect('accounts.db')
    cursor = conn.cursor()
    try:
        cursor.execute('INSERT INTO accounts (username, password) VALUES (?, ?)', (username, password))
        conn.commit()
        conn.close()
        return True
    except sqlite3.IntegrityError:
        conn.close()
        return False


def check_account(username, password):
    conn = sqlite3.connect('accounts.db')
    cursor = conn.cursor()
    cursor.execute('SELECT * FROM accounts WHERE username = ? AND password = ?', (username, password))
    user = cursor.fetchone()
    conn.close()
    return user
```


### 웹 사이트 최종 파일
---
최종적으로 완성되는 파일 구조는 다음과 같다. 

```
.
├── app.py
├── db.py
└── templates
    ├── base.html
    ├── index.html
    ├── login_failure.html
    ├── login.html
    ├── register_failure.html
    └── register.html
```

최종적으로 완성된 코드가 만약 잘 동작하지 않으면, [이 링크](https://dreamhack-lecture.s3.ap-northeast-2.amazonaws.com/uploads/web-service/flask-app-login-final-v2.zip)에서 압축 파일 형태로 제공하니, 다운로드 받아 [[실습 - 깔끔한 코드 패턴 만들기#재구성된 웹 사이트 테스트하기|앞에서 테스트 하는 과정]]을 참고해서 테스트하면 된다. 


## 마치며
---
이번 강의를 통해 기존에 구현된 회원가입, 로그인, 로그아웃 기능을 가진 웹 사이트를 **더 직관적이고 확장 가능한 구조로 재구성**하는 방법을 배웠다. 

강의에서는 HTML 템플릿 상속을 활용해 중복된 HTML 코드를 제거하고, 데이터베이스 관련 코드를 별도의 모듈로 분리해 사용하는 방법을 학습했다. 또한, 메인 페이지인 `/` 경로를 중심으로 웹 사이트의 기능을 통합해 사용자가 자연스러운 흐름으로 URL을 일일히 입력하지 않아도 웹 사이트를 사용할 수 있도록 했다. 

이번 강의를 통해 효율적이고 체계적으로 코드를 작성하는 방법과 그 중요성을 이해하고 넘어가는 게 나중에 웹 사이트를 제작할 때 도움이 될 것이다. 
